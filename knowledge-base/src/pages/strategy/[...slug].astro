---
import Layout from '../../layouts/Layout.astro';
import PageFooter from '../../components/PageFooter.astro';
import BackLink from '../../components/BackLink.astro';
import SessionResume from '../../components/SessionResume.astro';
import { getCollection, render } from 'astro:content';
import { tagColor, pipelineLabel, formatDate } from '../../lib/utils';

export async function getStaticPaths() {
  const docs = await getCollection('strategy');
  return docs.map((doc) => ({
    params: { slug: doc.id },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const { Content } = await render(doc);
const { title, subtitle, date, docType, phase, pipelinesCompleted, pipelinesLaunched, tags, sessionId, branch, status } = doc.data;
const dateStr = formatDate(date);
---

<Layout title={title} description={subtitle}>
  <main class="max-w-[720px] mx-auto px-6 py-12" data-pagefind-body>
    <BackLink href="/strategy" label="Back to Strategy" />

    {/* Tags + docType badge */}
    <div class="flex items-center gap-2 mb-4">
      <span class={`text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded ${docType === 'planning' ? 'bg-action/12 text-action' : 'bg-warning/12 text-warning'}`}>
        {docType}
      </span>
      {tags.map((tag) => (
        <span class={`text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded ${tagColor(tag)}`}>
          {tag}
        </span>
      ))}
    </div>

    <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">{title}</h1>
    <p class="text-[15px] text-text-secondary leading-relaxed mb-6">{subtitle}</p>

    {/* Meta grid */}
    <div class="border border-border rounded-lg overflow-hidden mb-6">
      <div class="grid grid-cols-2">
        <div class="px-4 py-3 border-b border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Date</div>
          <div class="text-sm text-text-primary">{dateStr}</div>
        </div>
        <div class="px-4 py-3 border-b border-border border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Phase</div>
          <div class="text-sm text-text-primary">Phase {phase}</div>
        </div>
        <div class="px-4 py-3">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Status</div>
          <div class={`text-sm font-medium ${status === 'complete' ? 'text-success' : 'text-action'}`}>
            {status === 'complete' ? 'Complete' : 'In Progress'}
          </div>
        </div>
        <div class="px-4 py-3 border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Branch</div>
          <div class="text-sm">
            {branch ? (
              <code class="font-mono text-xs bg-bg-surface px-1.5 py-0.5 rounded text-action">{branch}</code>
            ) : (
              <span class="text-text-muted">--</span>
            )}
          </div>
        </div>
      </div>
    </div>

    {/* Pipelines completed */}
    {pipelinesCompleted && pipelinesCompleted.length > 0 && (
      <div class="mb-4" data-pagefind-ignore>
        <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Pipelines Completed</div>
        <div class="flex flex-wrap gap-1.5">
          {pipelinesCompleted.map((p) => (
            <a href={`/pipelines/${p}`} class="inline-flex items-center bg-success/10 text-success text-xs font-medium px-2 py-0.5 rounded hover:bg-success/20 transition-colors">
              {pipelineLabel(p)}
            </a>
          ))}
        </div>
      </div>
    )}

    {/* Pipelines launched */}
    {pipelinesLaunched && pipelinesLaunched.length > 0 && (
      <div class="mb-4" data-pagefind-ignore>
        <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Pipelines Launched</div>
        <div class="flex flex-wrap gap-1.5">
          {pipelinesLaunched.map((p) => (
            <a href={`/pipelines/${p}`} class="inline-flex items-center bg-action/10 text-action text-xs font-medium px-2 py-0.5 rounded hover:bg-action/20 transition-colors">
              {pipelineLabel(p)}
            </a>
          ))}
        </div>
      </div>
    )}

    <SessionResume sessionId={sessionId} />

    <hr class="border-t border-border mb-8" />

    <div class="prose">
      <Content />
    </div>

    <PageFooter label={`${title} \u2014 ${dateStr}`} />
  </main>
</Layout>
