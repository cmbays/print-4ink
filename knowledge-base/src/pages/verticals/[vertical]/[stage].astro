---
import Layout from '../../../layouts/Layout.astro';
import Pipeline from '../../../components/Pipeline.astro';
import DocCard from '../../../components/DocCard.astro';
import { getCollection } from 'astro:content';

const verticalLabels: Record<string, string> = {
  quoting: 'Quoting',
  'customer-management': 'Customer Management',
  invoicing: 'Invoicing',
  'price-matrix': 'Price Matrix',
  jobs: 'Jobs',
  'screen-room': 'Screen Room',
  garments: 'Garments',
  dashboard: 'Dashboard',
  meta: 'Meta',
};

const stageLabels: Record<string, string> = {
  research: 'Research',
  interview: 'Interview',
  breadboarding: 'Breadboarding',
  'implementation-planning': 'Implementation Planning',
  build: 'Build',
  review: 'Review',
  learnings: 'Learnings',
};

const allStages = [
  'research',
  'interview',
  'breadboarding',
  'implementation-planning',
  'build',
  'review',
  'learnings',
];

export async function getStaticPaths() {
  const sessions = await getCollection('sessions');

  // Collect all unique vertical+stage combinations that have sessions
  const combos = new Set<string>();
  for (const session of sessions) {
    combos.add(`${session.data.vertical}::${session.data.stage}`);
  }

  return Array.from(combos).map((combo) => {
    const [vertical, stage] = combo.split('::');
    return { params: { vertical, stage } };
  });
}

const { vertical, stage } = Astro.params;
const verticalLabel = verticalLabels[vertical] || vertical;
const stageLabel = stageLabels[stage] || stage;

const allSessions = await getCollection('sessions');
const verticalSessions = allSessions.filter((s) => s.data.vertical === vertical);
const stageSessions = verticalSessions
  .filter((s) => s.data.stage === stage)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Build stage breakdown for pipeline
const stageBreakdown: Record<string, number> = {};
for (const s of allStages) {
  stageBreakdown[s] = verticalSessions.filter((sess) => sess.data.stage === s).length;
}

// Build pipeline stages with current stage active
const pipelineStages = allStages.map((s) => ({
  name: s,
  slug: s,
  count: stageBreakdown[s] || 0,
  active: s === stage,
}));
---

<Layout title={`${verticalLabel} — ${stageLabel}`}>
  <main class="max-w-[820px] mx-auto px-6 py-10">
    {/* Back link */}
    <a
      href={`/verticals/${vertical}`}
      class="inline-flex items-center gap-1 text-[13px] text-text-muted hover:text-action transition-colors mb-6"
    >
      <span>&larr;</span>
      <span>Back to {verticalLabel}</span>
    </a>

    {/* Title */}
    <h1 class="text-2xl font-bold tracking-tight text-text-primary mb-1">
      {verticalLabel}
      <span class="text-text-muted font-normal"> — </span>
      <span class="text-action">{stageLabel}</span>
    </h1>
    <p class="text-[14px] text-text-secondary mb-8">
      {stageSessions.length} session{stageSessions.length !== 1 ? 's' : ''} in this stage
    </p>

    {/* Pipeline stepper with active stage */}
    <div class="mb-10">
      <div class="bg-bg-elevated border border-border rounded-lg px-6 py-4">
        <Pipeline stages={pipelineStages} vertical={vertical} />
      </div>
    </div>

    {/* Sessions list */}
    <div>
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-4">
        Sessions
      </h2>
      {stageSessions.length === 0 ? (
        <p class="text-[14px] text-text-muted py-8 text-center">
          No sessions found for this stage.
        </p>
      ) : (
        <ul class="space-y-3">
          {stageSessions.map((session) => (
            <li>
              <DocCard
                title={session.data.title}
                subtitle={session.data.subtitle}
                date={session.data.date}
                vertical={session.data.vertical}
                stage={session.data.stage}
                tags={session.data.tags}
                status={session.data.status}
                slug={session.id}
              />
            </li>
          ))}
        </ul>
      )}
    </div>
  </main>
</Layout>
