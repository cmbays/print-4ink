---
import Layout from '../../layouts/Layout.astro';
import Pipeline from '../../components/Pipeline.astro';
import VerticalHealth from '../../components/VerticalHealth.astro';
import DocCard from '../../components/DocCard.astro';
import { getCollection } from 'astro:content';

const verticals = [
  'quoting',
  'customer-management',
  'invoicing',
  'price-matrix',
  'jobs',
  'screen-room',
  'garments',
  'dashboard',
  'meta',
];

const verticalLabels: Record<string, string> = {
  quoting: 'Quoting',
  'customer-management': 'Customer Management',
  invoicing: 'Invoicing',
  'price-matrix': 'Price Matrix',
  jobs: 'Jobs',
  'screen-room': 'Screen Room',
  garments: 'Garments',
  dashboard: 'Dashboard',
  meta: 'Meta',
};

const allStages = [
  'research',
  'interview',
  'breadboarding',
  'implementation-planning',
  'build',
  'review',
  'learnings',
];

export function getStaticPaths() {
  return [
    'quoting',
    'customer-management',
    'invoicing',
    'price-matrix',
    'jobs',
    'screen-room',
    'garments',
    'dashboard',
    'meta',
  ].map((v) => ({ params: { vertical: v } }));
}

const { vertical } = Astro.params;
const label = verticalLabels[vertical] || vertical;

const allSessions = await getCollection('sessions');
const verticalSessions = allSessions.filter((s) => s.data.vertical === vertical);
const sorted = verticalSessions.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Compute stage breakdown
const stageBreakdown: Record<string, number> = {};
for (const stage of allStages) {
  stageBreakdown[stage] = verticalSessions.filter((s) => s.data.stage === stage).length;
}

// Build pipeline stages
const pipelineStages = allStages.map((stage) => ({
  name: stage,
  slug: stage,
  count: stageBreakdown[stage] || 0,
  active: false,
}));

// Compute health status
const coreStages = ['research', 'breadboarding', 'build'];
const hasCoreStages = coreStages.every((s) => (stageBreakdown[s] || 0) > 0);
const healthStatus = hasCoreStages ? 'Active' : 'In Progress';

// Latest date
const latestDate = sorted.length > 0 ? sorted[0].data.date : new Date();
---

<Layout title={label}>
  <main class="max-w-[820px] mx-auto px-6 py-10">
    {/* Back link */}
    <a
      href="/"
      class="inline-flex items-center gap-1 text-[13px] text-text-muted hover:text-action transition-colors mb-6"
    >
      <span>&larr;</span>
      <span>Back to Index</span>
    </a>

    {/* Title */}
    <h1 class="text-2xl font-bold tracking-tight text-text-primary mb-1">
      {label}
    </h1>
    <p class="text-[14px] text-text-secondary mb-8">
      {sorted.length} session{sorted.length !== 1 ? 's' : ''} across {Object.values(stageBreakdown).filter((c) => c > 0).length} stages
    </p>

    {/* Health summary */}
    <div class="mb-8">
      <VerticalHealth
        vertical={vertical}
        totalSessions={sorted.length}
        stageBreakdown={stageBreakdown}
        latestDate={latestDate}
        status={healthStatus}
      />
    </div>

    {/* Pipeline stepper */}
    <div class="mb-10">
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-3">
        Pipeline
      </h2>
      <div class="bg-bg-elevated border border-border rounded-lg px-6 py-4">
        <Pipeline stages={pipelineStages} vertical={vertical} />
      </div>
    </div>

    {/* Sessions list */}
    <div>
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-4">
        Sessions
      </h2>
      {sorted.length === 0 ? (
        <p class="text-[14px] text-text-muted py-8 text-center">
          No sessions found for this vertical.
        </p>
      ) : (
        <ul class="space-y-3">
          {sorted.map((session) => (
            <li>
              <DocCard
                title={session.data.title}
                subtitle={session.data.subtitle}
                date={session.data.date}
                vertical={session.data.vertical}
                verticalSecondary={session.data.verticalSecondary}
                stage={session.data.stage}
                tags={session.data.tags}
                status={session.data.status}
                slug={session.id}
              />
            </li>
          ))}
        </ul>
      )}
    </div>
  </main>
</Layout>
