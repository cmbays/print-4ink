---
import Layout from '../../layouts/Layout.astro';
import Pipeline from '../../components/Pipeline.astro';
import VerticalHealth from '../../components/VerticalHealth.astro';
import DocCard from '../../components/DocCard.astro';
import { getCollection } from 'astro:content';
import { pipelineLabel as getPipelineLabel } from '../../lib/utils';
import stagesConfig from '../../../../config/stages.json';

const allStages = stagesConfig
  .filter((s: { slug: string; label: string; pipeline?: boolean }) => s.pipeline !== false)
  .map((s: { slug: string }) => s.slug);

export async function getStaticPaths() {
  const docs = await getCollection('pipelines');
  const unique = [...new Set(docs.map((d) => d.data.pipelineName))];
  return unique.map((slug) => ({ params: { pipeline: slug } }));
}

const { pipeline } = Astro.params;
const label = getPipelineLabel(pipeline);

const allDocs = await getCollection('pipelines');
const pipelineDocs = allDocs.filter((s) => s.data.pipelineName === pipeline);
const sorted = pipelineDocs.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Compute stage breakdown
const stageBreakdown: Record<string, number> = {};
for (const stage of allStages) {
  stageBreakdown[stage] = pipelineDocs.filter((s) => s.data.stage === stage).length;
}

// Build pipeline stages
const pipelineStages = allStages.map((stage) => ({
  name: stage,
  slug: stage,
  count: stageBreakdown[stage] || 0,
  active: false,
}));

// Compute health status
const coreStages = ['research', 'breadboard', 'build'];
const hasCoreStages = coreStages.every((s) => (stageBreakdown[s] || 0) > 0);
const healthStatus = hasCoreStages ? 'Active' : 'In Progress';

// Latest date
const latestDate = sorted.length > 0 ? sorted[0].data.date : new Date();
---

<Layout title={label}>
  <main class="max-w-[820px] mx-auto px-6 py-10">
    {/* Back link */}
    <a
      href="/"
      class="inline-flex items-center gap-1 text-[13px] text-text-muted hover:text-action transition-colors mb-6"
    >
      <span>&larr;</span>
      <span>Back to Index</span>
    </a>

    {/* Title */}
    <h1 class="text-2xl font-bold tracking-tight text-text-primary mb-1">
      {label}
    </h1>
    <p class="text-[14px] text-text-secondary mb-8">
      {sorted.length} pipeline doc{sorted.length !== 1 ? 's' : ''} across {Object.values(stageBreakdown).filter((c) => c > 0).length} stages
    </p>

    {/* Health summary */}
    <div class="mb-8">
      <VerticalHealth
        pipeline={pipeline}
        totalDocs={sorted.length}
        stageBreakdown={stageBreakdown}
        latestDate={latestDate}
        status={healthStatus}
      />
    </div>

    {/* Pipeline stepper */}
    <div class="mb-10">
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-3">
        Pipeline
      </h2>
      <div class="bg-bg-elevated border border-border rounded-lg px-6 py-4">
        <Pipeline stages={pipelineStages} pipeline={pipeline} />
      </div>
    </div>

    {/* Pipeline docs list */}
    <div>
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-4">
        Pipeline Docs
      </h2>
      {sorted.length === 0 ? (
        <p class="text-[14px] text-text-muted py-8 text-center">
          No pipeline docs found for this pipeline.
        </p>
      ) : (
        <ul class="space-y-3">
          {sorted.map((doc) => (
            <li>
              <DocCard
                title={doc.data.title}
                subtitle={doc.data.subtitle}
                date={doc.data.date}
                pipeline={doc.data.pipelineName}
                pipelineType={doc.data.pipelineType}
                stage={doc.data.stage}
                tags={doc.data.tags}
                status={doc.data.status}
                slug={doc.id}
              />
            </li>
          ))}
        </ul>
      )}
    </div>
  </main>
</Layout>
