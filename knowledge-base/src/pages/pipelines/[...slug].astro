---
import Layout from '../../layouts/Layout.astro';
import WorkflowChain from '../../components/WorkflowChain.astro';
import PageFooter from '../../components/PageFooter.astro';
import BackLink from '../../components/BackLink.astro';
import { getCollection, render } from 'astro:content';
import { tagColor, pipelineLabel, stageLabel, productLabel, toolLabel, statusColor, statusLabel, formatDate, labelFromSlug } from '../../lib/utils';

export async function getStaticPaths() {
  const docs = await getCollection('pipelines');
  return docs.map((doc) => ({
    params: { slug: doc.id },
    props: { doc },
  }));
}

const { doc } = Astro.props;

const allDocs = await getCollection('pipelines');
const workflowSessions = allDocs
  .filter((s) => s.data.pipelineName === doc.data.pipelineName)
  .map((s) => ({
    slug: s.id,
    title: s.data.title,
    stage: s.data.stage,
    date: s.data.date,
  }));
const { Content } = await render(doc);

const { title, subtitle, date, phase, pipelineName: pipeline, pipelineType, products, tools, stage, tags, sessionId, branch, pr, status } = doc.data;

const dateStr = formatDate(date);
---

<Layout title={title} description={subtitle}>
  <main class="max-w-[720px] mx-auto px-6 py-12" data-pagefind-body>
    <BackLink href="/" label="Back to Index" />

    <!-- Tag pills -->
    <div class="flex items-center gap-2 mb-4">
      {tags.map((tag) => (
        <span class={`text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded ${tagColor(tag)}`} data-pagefind-filter={`tag:${tag}`}>
          {tag}
        </span>
      ))}
    </div>

    <!-- Title -->
    <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">{title}</h1>
    <span data-pagefind-meta={`pipeline:${pipelineLabel(pipeline)}`} class="hidden"></span>
    <span data-pagefind-meta={`stage:${stageLabel(stage)}`} class="hidden"></span>

    <!-- Subtitle -->
    <p class="text-[15px] text-text-secondary leading-relaxed mb-6">{subtitle}</p>

    <!-- Meta grid -->
    <div class="border border-border rounded-lg overflow-hidden mb-6">
      <div class="grid grid-cols-2">
        <!-- Row 1 -->
        <div class="px-4 py-3 border-b border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Date</div>
          <div class="text-sm text-text-primary">{dateStr}</div>
        </div>
        <div class="px-4 py-3 border-b border-border border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Branch</div>
          <div class="text-sm">
            {branch ? (
              <code class="font-mono text-xs bg-bg-surface px-1.5 py-0.5 rounded text-action">{branch}</code>
            ) : (
              <span class="text-text-muted">--</span>
            )}
          </div>
        </div>

        <!-- Row 2 -->
        <div class="px-4 py-3 border-b border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Phase</div>
          <div class="text-sm text-text-primary">Phase {phase}</div>
        </div>
        <div class="px-4 py-3 border-b border-border border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Pipeline</div>
          <div class="text-sm text-text-primary">
            <a href={`/pipelines/${pipeline}`} class="text-action hover:underline">{pipelineLabel(pipeline)}</a>
          </div>
        </div>

        <!-- Row 3 -->
        <div class="px-4 py-3 border-b border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Stage</div>
          <div class="text-sm">
            <a href={`/pipelines/${pipeline}/${stage}`} class="inline-flex items-center bg-bg-surface text-action text-xs font-medium px-2 py-0.5 rounded hover:bg-action/10 transition-colors">
              {stageLabel(stage)}
            </a>
          </div>
        </div>
        <div class="px-4 py-3 border-b border-border border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Status</div>
          <div class={`text-sm font-medium ${statusColor(status)}`}>
            {statusLabel(status)}
          </div>
        </div>

        <!-- Row 4: Pipeline Type -->
        <div class="px-4 py-3">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Pipeline Type</div>
          <div class="text-sm text-text-primary">{labelFromSlug(pipelineType)}</div>

        </div>
        <div class="px-4 py-3 border-l border-border">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Products</div>
          <div class="text-sm text-text-primary">
            {products && products.length > 0 ? (
              <div class="flex flex-wrap gap-1">
                {products.map((p) => (
                  <span class="inline-flex items-center bg-bg-surface text-text-secondary text-xs px-2 py-0.5 rounded">
                    {productLabel(p)}
                  </span>
                ))}
              </div>
            ) : (
              <span class="text-text-muted">--</span>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Tools -->
    {tools && tools.length > 0 && (
      <div class="mb-6" data-pagefind-ignore>
        <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Tools</div>
        <div class="flex flex-wrap gap-1.5">
          {tools.map((t) => (
            <span class="inline-flex items-center bg-bg-surface text-text-secondary text-xs px-2 py-0.5 rounded border border-border">
              {toolLabel(t)}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Workflow chain -->
    {workflowSessions.length > 1 && (
      <div class="mb-6" data-pagefind-ignore>
        <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Workflow Chain</div>
        <div class="bg-bg-elevated border border-border rounded-lg px-4 py-2">
          <WorkflowChain
            currentSlug={doc.id}
            pipeline={pipeline}
            allPipelines={workflowSessions}
          />
        </div>
      </div>
    )}

    <!-- Session resume -->
    {sessionId && (
      <div class="bg-bg-elevated border border-border rounded-lg px-4 py-3 mb-6" data-pagefind-ignore>
        <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Resume Session</div>
        <code class="font-mono text-xs text-action select-all">claude --resume {sessionId}</code>
      </div>
    )}

    <!-- PR link -->
    {pr && (
      <div class="mb-6" data-pagefind-ignore>
        <a
          href={pr}
          class="inline-flex items-center gap-1.5 text-sm text-action hover:underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          View Pull Request &rarr;
        </a>
      </div>
    )}

    <!-- Divider -->
    <hr class="border-t border-border mb-8" />

    <!-- Body content -->
    <div class="prose">
      <Content />
    </div>

    <PageFooter label={`${title} \u2014 ${dateStr}`} />
  </main>
</Layout>
