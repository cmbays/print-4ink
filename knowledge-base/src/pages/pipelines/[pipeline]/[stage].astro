---
import Layout from '../../../layouts/Layout.astro';
import Pipeline from '../../../components/Pipeline.astro';
import DocCard from '../../../components/DocCard.astro';
import { getCollection } from 'astro:content';
import { pipelineLabel as getPipelineLabel, stageLabel as getStageLabel } from '../../../lib/utils';
import stagesConfig from '../../../../../config/stages.json';

const allStages = stagesConfig
  .filter((s: { slug: string; label: string; pipeline?: boolean }) => s.pipeline !== false)
  .map((s: { slug: string }) => s.slug);

export async function getStaticPaths() {
  const docs = await getCollection('pipelines');

  // Collect all unique pipeline+stage combinations that have docs
  const combos = new Set<string>();
  for (const doc of docs) {
    combos.add(`${doc.data.pipelineName}::${doc.data.stage}`);
  }

  return Array.from(combos).map((combo) => {
    const [pipeline, stage] = combo.split('::');
    return { params: { pipeline, stage } };
  });
}

const { pipeline, stage } = Astro.params;
const pipelineLabel = getPipelineLabel(pipeline);
const stageLabel = getStageLabel(stage);

const allDocs = await getCollection('pipelines');
const pipelineDocs = allDocs.filter((s) => s.data.pipelineName === pipeline);
const stageDocs = pipelineDocs
  .filter((s) => s.data.stage === stage)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Build stage breakdown for pipeline
const stageBreakdown: Record<string, number> = {};
for (const s of allStages) {
  stageBreakdown[s] = pipelineDocs.filter((doc) => doc.data.stage === s).length;
}

// Build pipeline stages with current stage active
const pipelineStages = allStages.map((s) => ({
  name: s,
  slug: s,
  count: stageBreakdown[s] || 0,
  active: s === stage,
}));
---

<Layout title={`${pipelineLabel} — ${stageLabel}`}>
  <main class="max-w-[820px] mx-auto px-6 py-10">
    {/* Back link */}
    <a
      href={`/pipelines/${pipeline}`}
      class="inline-flex items-center gap-1 text-[13px] text-text-muted hover:text-action transition-colors mb-6"
    >
      <span>&larr;</span>
      <span>Back to {pipelineLabel}</span>
    </a>

    {/* Title */}
    <h1 class="text-2xl font-bold tracking-tight text-text-primary mb-1">
      {pipelineLabel}
      <span class="text-text-muted font-normal"> — </span>
      <span class="text-action">{stageLabel}</span>
    </h1>
    <p class="text-[14px] text-text-secondary mb-8">
      {stageDocs.length} pipeline doc{stageDocs.length !== 1 ? 's' : ''} in this stage
    </p>

    {/* Pipeline stepper with active stage */}
    <div class="mb-10">
      <div class="bg-bg-elevated border border-border rounded-lg px-6 py-4">
        <Pipeline stages={pipelineStages} pipeline={pipeline} />
      </div>
    </div>

    {/* Pipeline docs list */}
    <div>
      <h2 class="text-[11px] font-semibold uppercase tracking-widest text-text-muted mb-4">
        Pipeline Docs
      </h2>
      {stageDocs.length === 0 ? (
        <p class="text-[14px] text-text-muted py-8 text-center">
          No pipeline docs found for this stage.
        </p>
      ) : (
        <ul class="space-y-3">
          {stageDocs.map((doc) => (
            <li>
              <DocCard
                title={doc.data.title}
                subtitle={doc.data.subtitle}
                date={doc.data.date}
                pipeline={doc.data.pipelineName}
                pipelineType={doc.data.pipelineType}
                stage={doc.data.stage}
                tags={doc.data.tags}
                status={doc.data.status}
                slug={doc.id}
              />
            </li>
          ))}
        </ul>
      )}
    </div>
  </main>
</Layout>
