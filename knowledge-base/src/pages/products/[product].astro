---
import Layout from '../../layouts/Layout.astro';
import PageFooter from '../../components/PageFooter.astro';
import BackLink from '../../components/BackLink.astro';
import RelatedPipelinesSection from '../../components/RelatedPipelinesSection.astro';
import { getCollection, render } from 'astro:content';
import { sortByDateDesc, pluralize } from '../../lib/utils';
import productsConfig from '../../../../config/products.json';

export function getStaticPaths() {
  return productsConfig.map((p) => ({ params: { product: p.slug } }));
}

const { product } = Astro.params;
const config = productsConfig.find((p) => p.slug === product);
if (!config) throw new Error(`Unknown product slug: ${product}`);

const allProductDocs = await getCollection('productDocs');
const docs = allProductDocs.filter((d) => d.data.product === product);
const overview = docs.find((d) => d.data.docType === 'overview');

const pipelines = await getCollection('pipelines');
const relatedPipelines = pipelines
  .filter((p) => p.data.products?.includes(product))
  .sort(sortByDateDesc);

let OverviewContent: Awaited<ReturnType<typeof render>>['Content'] | null = null;
if (overview) {
  const rendered = await render(overview);
  OverviewContent = rendered.Content;
}
---

<Layout title={config.label} description={`${config.label} product documentation`}>
  <main class="max-w-[720px] mx-auto px-6 py-12" data-pagefind-body>
    <BackLink href="/products" label="Back to Products" />

    <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">{config.label}</h1>
    <p class="text-[15px] text-text-secondary leading-relaxed mb-2">{overview?.data.subtitle || ''}</p>
    <div class="flex items-center gap-3 text-[12px] text-text-muted mb-6">
      <code class="font-mono text-[11px] bg-bg-surface px-1.5 py-0.5 rounded text-action">{config.route}</code>
      <span class="opacity-40">&middot;</span>
      <span>{pluralize(relatedPipelines.length, 'pipeline doc')}</span>
    </div>

    {/* Overview content */}
    {OverviewContent && (
      <div class="prose mb-8">
        <OverviewContent />
      </div>
    )}

    <hr class="border-t border-border mb-8" />

    <RelatedPipelinesSection
      pipelines={relatedPipelines}
      emptyMessage="No pipeline docs linked to this product yet."
    />

    <PageFooter label={config.label} />
  </main>
</Layout>
