---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import productsConfig from '../../../../config/products.json';

const productDocs = await getCollection('productDocs');
const pipelines = await getCollection('pipelines');

// Build product cards with overview doc data and pipeline counts
const productCards = productsConfig.map((p) => {
  const overview = productDocs.find((d) => d.data.product === p.slug && d.data.docType === 'overview');
  const linkedPipelines = pipelines.filter((pl) => pl.data.products?.includes(p.slug));
  return {
    slug: p.slug,
    label: p.label,
    route: p.route,
    subtitle: overview?.data.subtitle || '',
    status: overview?.data.status || 'draft',
    pipelineCount: linkedPipelines.length,
  };
});
---

<Layout title="Products">
  <main class="max-w-[820px] mx-auto px-6 py-12">
    <a href="/" class="inline-flex items-center gap-1.5 text-text-muted text-sm hover:text-action transition-colors mb-8">
      <span>&larr;</span> Back to Index
    </a>

    <h1 class="text-2xl font-bold tracking-tight mb-2">Products</h1>
    <p class="text-text-secondary text-sm mb-8">App features and their documentation</p>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      {productCards.map((p) => (
        <a href={`/products/${p.slug}`} class="block bg-bg-elevated border border-border rounded-lg p-4 hover:border-action/30 transition-colors group">
          <div class="flex items-center justify-between mb-1.5">
            <h3 class="text-sm font-semibold text-text-primary group-hover:text-action transition-colors">{p.label}</h3>
            <span class={`text-[10px] font-semibold uppercase tracking-wide px-1.5 py-0.5 rounded ${p.status === 'current' ? 'bg-success/12 text-success' : 'bg-warning/12 text-warning'}`}>
              {p.status}
            </span>
          </div>
          <p class="text-[13px] text-text-secondary line-clamp-2 mb-2">{p.subtitle}</p>
          <div class="flex items-center gap-3 text-[11px] text-text-muted">
            <span>{p.pipelineCount} pipeline doc{p.pipelineCount !== 1 ? 's' : ''}</span>
            <span class="opacity-40">&middot;</span>
            <code class="font-mono text-[10px] text-text-muted">{p.route}</code>
          </div>
        </a>
      ))}
    </div>

    <footer class="mt-16 pt-6 border-t border-border">
      <p class="text-xs text-text-muted text-center">Screen Print Pro &mdash; Products</p>
    </footer>
  </main>
</Layout>
