---
import Layout from '../../layouts/Layout.astro';
import PageFooter from '../../components/PageFooter.astro';
import BackLink from '../../components/BackLink.astro';
import RelatedPipelinesSection from '../../components/RelatedPipelinesSection.astro';
import { getCollection, render } from 'astro:content';
import { sortByDateDesc, pluralize } from '../../lib/utils';
import toolsConfig from '../../../../config/tools.json';

export function getStaticPaths() {
  return toolsConfig.map((t) => ({ params: { tool: t.slug } }));
}

const { tool } = Astro.params;
const config = toolsConfig.find((t) => t.slug === tool);
if (!config) throw new Error(`Unknown tool slug: ${tool}`);

const allToolDocs = await getCollection('toolDocs');
const docs = allToolDocs.filter((d) => d.data.tool === tool);
const overview = docs.find((d) => d.data.docType === 'overview');

const pipelines = await getCollection('pipelines');
const relatedPipelines = pipelines
  .filter((p) => p.data.tools?.includes(tool))
  .sort(sortByDateDesc);

let OverviewContent: Awaited<ReturnType<typeof render>>['Content'] | null = null;
if (overview) {
  const rendered = await render(overview);
  OverviewContent = rendered.Content;
}
---

<Layout title={config.label} description={`${config.label} tool documentation`}>
  <main class="max-w-[720px] mx-auto px-6 py-12" data-pagefind-body>
    <BackLink href="/tools" label="Back to Tools" />

    <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">{config.label}</h1>
    <p class="text-[15px] text-text-secondary leading-relaxed mb-2">{overview?.data.subtitle || ''}</p>
    <div class="flex items-center gap-3 text-[12px] text-text-muted mb-6">
      <span>{pluralize(relatedPipelines.length, 'pipeline doc')}</span>
    </div>

    {/* Overview content */}
    {OverviewContent && (
      <div class="prose mb-8">
        <OverviewContent />
      </div>
    )}

    <hr class="border-t border-border mb-8" />

    <RelatedPipelinesSection
      pipelines={relatedPipelines}
      emptyMessage="No pipeline sessions linked to this tool yet."
    />

    <PageFooter label={config.label} />
  </main>
</Layout>
