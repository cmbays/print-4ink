---
import verticalsConfig from '../../../config/verticals.json';
import stagesConfig from '../../../config/stages.json';
import tagsConfig from '../../../config/tags.json';

interface Props {
  title: string;
  subtitle: string;
  date: Date;
  pipeline: string;
  pipelineType?: string;
  stage: string;
  tags: string[];
  status: string;
  slug: string;
}

const { title, subtitle, date, pipeline, pipelineType, stage, tags, status, slug } = Astro.props;

const dateStr = date.toISOString().split('T')[0];

const TAG_COLOR_CLASSES: Record<string, string> = {
  green: 'bg-success/12 text-success',
  blue: 'bg-action/12 text-action',
  amber: 'bg-warning/12 text-warning',
  purple: 'bg-purple/12 text-purple',
};

const tagColorMap: Record<string, string> = Object.fromEntries(
  tagsConfig.map((t) => [t.slug, TAG_COLOR_CLASSES[t.color] || 'bg-bg-surface text-text-muted'])
);

function tagColor(tag: string): string {
  return tagColorMap[tag] || 'bg-bg-surface text-text-muted';
}

const pipelineLabelMap: Record<string, string> = Object.fromEntries(
  verticalsConfig.map((v) => [v.slug, v.label])
);

function pipelineLabel(v: string): string {
  return pipelineLabelMap[v] || v;
}

const stageLabelMap: Record<string, string> = Object.fromEntries(
  stagesConfig.map((s) => [s.slug, s.label])
);

function stageLabel(s: string): string {
  return stageLabelMap[s] || s.split('-').map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}
---

<a
  href={`/pipelines/${slug}`}
  class="block bg-bg-elevated border border-border rounded-lg p-4 hover:border-action/30 transition-colors group"
>
  <!-- Tags row -->
  <div class="flex items-center gap-1.5 mb-1.5">
    {tags.map((tag) => (
      <span class={`text-[10px] font-semibold uppercase tracking-wide px-1.5 py-0.5 rounded ${tagColor(tag)}`}>
        {tag}
      </span>
    ))}
    {status === 'in-progress' && (
      <span class="text-[10px] font-semibold uppercase tracking-wide px-1.5 py-0.5 rounded bg-warning/12 text-warning ml-auto">
        In Progress
      </span>
    )}
    {status === 'superseded' && (
      <span class="text-[10px] font-semibold uppercase tracking-wide px-1.5 py-0.5 rounded bg-error/12 text-error ml-auto">
        Superseded
      </span>
    )}
  </div>

  <!-- Title -->
  <h3 class="text-[14px] font-semibold text-text-primary leading-snug group-hover:text-action transition-colors">
    {title}
  </h3>

  <!-- Subtitle -->
  <p class="text-[13px] text-text-secondary mt-0.5 line-clamp-2 leading-relaxed">
    {subtitle}
  </p>

  <!-- Meta row -->
  <div class="flex items-center gap-1.5 mt-2 text-[11px] text-text-muted">
    <span>{dateStr}</span>
    <span class="opacity-40">&middot;</span>
    <span>{pipelineLabel(pipeline)}</span>
    {pipelineType && pipelineType !== 'vertical' && (
      <span class="px-1.5 py-0.5 rounded bg-purple/10 text-purple text-[10px]">
        {pipelineType}
      </span>
    )}
    <span class="opacity-40">&middot;</span>
    <span class="px-1.5 py-0.5 rounded bg-bg-surface text-text-muted text-[10px]">
      {stageLabel(stage)}
    </span>
  </div>
</a>
