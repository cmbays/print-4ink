---
import stagesConfig from '../../../config/stages.json';

interface PipelineDoc {
  slug: string;
  title: string;
  stage: string;
  date: Date;
}

interface Props {
  currentSlug: string;
  pipeline: string;
  allPipelines: PipelineDoc[];
}

const { currentSlug, pipeline, allPipelines } = Astro.props;

const stageOrder = stagesConfig
  .filter((s) => s.pipeline !== false)
  .map((s) => s.slug);

const shortStageLabels: Record<string, string> = Object.fromEntries(
  stagesConfig
    .filter((s) => s.pipeline !== false)
    .map((s) => [s.slug, s.label])
);

// Sort by stage order, then by date (filtering done by caller)
const chainSessions = allPipelines.sort((a, b) => {
    const stageA = stageOrder.indexOf(a.stage);
    const stageB = stageOrder.indexOf(b.stage);
    if (stageA !== stageB) return stageA - stageB;
    return a.date.getTime() - b.date.getTime();
  });

// Truncate title to fit in pill
function truncateTitle(title: string, maxLen: number = 24): string {
  if (title.length <= maxLen) return title;
  return title.slice(0, maxLen - 1) + '\u2026';
}
---

{chainSessions.length > 1 && (
  <div class="overflow-x-auto">
    <div class="flex items-center gap-1.5 min-w-max py-2">
      {chainSessions.map((session, i) => {
        const isCurrent = session.slug === currentSlug;
        const stageLabel = shortStageLabels[session.stage] || session.stage;

        return (
          <>
            <a
              href={`/pipelines/${session.slug}`}
              class:list={[
                'inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap',
                isCurrent
                  ? 'bg-action/10 border-action/30 text-action font-medium'
                  : 'bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20',
              ]}
              title={session.title}
            >
              <span class="font-semibold">{stageLabel}</span>
              <span class="opacity-60">&middot;</span>
              <span class="opacity-80">{truncateTitle(session.title)}</span>
            </a>
            {i < chainSessions.length - 1 && (
              <span class="text-text-muted text-[11px] select-none">&rarr;</span>
            )}
          </>
        );
      })}
    </div>
  </div>
)}
