---
import Search from 'astro-pagefind/components/Search';
import { pipelineLabel, MAX_PHASE } from '../lib/utils';

interface Props {
  activeView?: string;
  docCount: number;
  pipelineCounts: Record<string, number>;
}

const { activeView = 'all', docCount, pipelineCounts } = Astro.props;

const views = [
  { id: 'all', label: 'All Pipelines', href: '/' },
  { id: 'products', label: 'Products', href: '/products' },
  { id: 'tools', label: 'Tools', href: '/tools' },
  { id: 'strategy', label: 'Strategy', href: '/strategy' },
  { id: 'decisions', label: 'Decisions', href: '/decisions' },
  { id: 'gary-tracker', label: 'Gary Tracker', href: '/gary-tracker' },
];

// Derive pipeline list from content data (pipelineCounts keys) instead of config
const pipelines = Object.keys(pipelineCounts)
  .sort()
  .map((slug) => ({ slug, label: pipelineLabel(slug) }));
---

<aside id="sidebar" class="hidden md:flex flex-col w-[260px] min-w-[260px] h-screen bg-bg-primary border-r border-border overflow-y-auto sticky top-0">
  <!-- Header -->
  <div class="px-5 pt-6 pb-4">
    <h1 class="text-sm font-bold tracking-tight text-text-primary">Knowledge Base</h1>
    <p class="text-[11px] text-text-muted mt-0.5" id="sidebar-session-count">{docCount} pipeline docs</p>
  </div>

  <!-- Search -->
  <div class="px-3 mb-4">
    <Search id="search" className="pagefind-ui" uiOptions={{ showImages: false, showSubResults: true, resetStyles: false }} />
  </div>

  <!-- Views -->
  <nav class="px-3 mb-6">
    <p class="px-2 mb-2 text-[10px] font-semibold uppercase tracking-widest text-text-muted">Views</p>
    <ul class="space-y-0.5">
      {views.map((view) => {
        const isActive = activeView === view.id;
        return (
          <li>
            <a
              href={view.href}
              data-view={view.id}
              class:list={[
                'sidebar-view-link block px-2 py-1.5 rounded-md text-[13px] transition-colors',
                isActive
                  ? 'text-action bg-action/5 font-medium'
                  : 'text-text-secondary hover:text-text-primary hover:bg-bg-elevated',
              ]}
            >
              {view.label}
            </a>
          </li>
        );
      })}
    </ul>
  </nav>

  <!-- Pipelines -->
  <nav class="px-3 flex-1">
    <p class="px-2 mb-2 text-[10px] font-semibold uppercase tracking-widest text-text-muted">Pipelines</p>
    <ul class="space-y-0.5">
      {pipelines.map((v) => {
        const count = pipelineCounts[v.slug] || 0;
        return (
          <li>
            <button
              type="button"
              data-pipeline-filter={v.slug}
              aria-label={`Filter by ${v.label} pipeline`}
              aria-pressed="false"
              class="sidebar-pipeline-btn flex items-center justify-between w-full px-2 py-1.5 rounded-md text-[13px] transition-colors text-text-secondary hover:text-text-primary hover:bg-bg-elevated text-left"
            >
              <span>{v.label}</span>
              {count > 0 && (
                <span
                  class="sidebar-pipeline-count text-[11px] font-medium px-1.5 py-0.5 rounded-full min-w-[20px] text-center bg-action/10 text-action"
                >
                  {count}
                </span>
              )}
            </button>
          </li>
        );
      })}
    </ul>
  </nav>

  <!-- Phase filter in sidebar -->
  <div class="px-3 pb-5 mt-4 border-t border-border pt-4">
    <p class="px-2 mb-2 text-[10px] font-semibold uppercase tracking-widest text-text-muted">Phase</p>
    <div class="flex gap-1.5 px-2" id="sidebar-phase-filters">
      {Array.from({ length: MAX_PHASE }, (_, i) => i + 1).map((phase) => (
        <button
          type="button"
          data-phase-filter={phase}
          aria-label={`Filter by Phase ${phase}`}
          aria-pressed="false"
          class="sidebar-phase-btn text-[11px] font-medium px-2.5 py-1 rounded-md border transition-colors text-center text-text-muted border-border hover:text-text-secondary hover:border-border"
        >
          P{phase}
        </button>
      ))}
    </div>
  </div>
</aside>

<!-- Mobile sidebar toggle -->
<button
  type="button"
  id="mobile-sidebar-toggle"
  class="md:hidden fixed top-4 left-4 z-50 bg-bg-elevated border border-border rounded-md p-2 text-text-secondary hover:text-text-primary transition-colors"
  aria-label="Toggle sidebar"
  aria-controls="sidebar"
  aria-expanded="false"
>
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</button>

<script>
  // Mobile sidebar toggle
  const toggle = document.getElementById('mobile-sidebar-toggle');
  const sidebar = document.getElementById('sidebar');
  if (toggle && sidebar) {
    toggle.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
      sidebar.classList.toggle('fixed');
      sidebar.classList.toggle('z-40');
      sidebar.classList.toggle('flex');
      const expanded = !sidebar.classList.contains('hidden');
      toggle.setAttribute('aria-expanded', String(expanded));
    });
  }
</script>
