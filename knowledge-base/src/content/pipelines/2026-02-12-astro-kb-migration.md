---
title: "Astro Knowledge Base Migration"
subtitle: "Migrated for_human/ static HTML docs to Astro 5.3 knowledge base with content collections, Pagefind search, pipeline visualization, and 50 static pages. Deleted 25k lines of old HTML/JS."
date: 2026-02-12
phase: 1
pipelineName: devx
pipelineType: horizontal
products: []
tools: [knowledge-base]
stage: build
tags: [feature, build, decision]
sessionId: "87c81dcf-555a-49cc-a349-6ac1c0194c1c"
branch: "session/0212-for-human-kb"
status: complete
---

## Migration Summary

| Stat | Value |
|------|-------|
| Old System | `for_human/` — 23 HTML files + 1450-line generator script |
| New System | `knowledge-base/` — Astro 5.3, 23 Markdown docs, 50 static pages |
| Lines Removed | ~25,000 (HTML, JS generator, stage pages, templates) |
| Lines Added | ~2,500 (Astro components, pages, styles, config) |
| Build Time | ~1 second |
| Search | Pagefind full-text with tag facets and sub-results |

## Why We Migrated

The old `for_human/` system was a static HTML SPA generated by a 1450-line Node.js script (`scripts/generate-for-human-index.js`). Every new session required hand-crafting an HTML file with `data-*` attributes, and the generator script was becoming unmaintainable. Problems:

1. **No search** — only client-side filtering by vertical/phase
2. **No content validation** — `data-*` attributes could have typos with no build-time check
3. **No component model** — duplicated markup across 23+ HTML files
4. **Generator complexity** — 1450 lines of DOM-building JS to produce index, stage pages, gary-tracker
5. **No Markdown** — session content trapped in HTML, hard to write and review

## What Was Built

### Astro Project (`knowledge-base/`)

- **Astro 5.3** with static output mode (no server adapter)
- **Tailwind CSS v4** via `@tailwindcss/vite` plugin (not `@astrojs/tailwind`)
- **React** integration for future interactive islands
- **Pagefind** integration for full-text search

### Content Collections

Zod-validated schema in `src/content.config.ts` enforces:
- Required fields: title, subtitle, date, phase, vertical, stage, tags
- Enum validation for verticals (9), stages (7), tags (6), status (3)
- Optional fields: sessionId, branch, pr, verticalSecondary

Build fails immediately on schema violations — no more silent metadata errors.

### 8 Components

| Component | Purpose |
|-----------|---------|
| `Sidebar.astro` | Fixed 260px nav with search, views, verticals, phase filter |
| `DocCard.astro` | Session card with tags, title, subtitle, meta row, cross-vertical badges |
| `Pipeline.astro` | 7-stage horizontal stepper with click-to-navigate |
| `PhaseFilter.astro` | Phase 1/2/3 toggle pills |
| `VerticalHealth.astro` | Vertical overview with stage coverage progress |
| `WorkflowChain.astro` | Auto-computed related sessions by vertical+stage |
| `GaryQuestion.astro` | Gary question card (answered/unanswered) |
| `DecisionRecord.astro` | Decision record card with amber accent |

### 6 Page Templates (50 pages)

| Template | Pages | Purpose |
|----------|-------|---------|
| `index.astro` | 1 | Main view with sidebar, filters, doc list |
| `sessions/[...slug].astro` | 23 | Individual session detail with meta grid, workflow chain |
| `verticals/[vertical].astro` | 9 | Vertical overview with health card + pipeline |
| `verticals/[vertical]/[stage].astro` | 15 | Stage summary with filtered sessions |
| `gary-tracker.astro` | 1 | Aggregated Gary questions across all sessions |
| `decisions.astro` | 1 | Decision log (sessions tagged `decision`) |

### Features

- **Pagefind search** — Full-text with highlighted snippets, sub-results linking to headings, tag facet filters
- **Client-side filtering** — Vertical, phase, and status filters with URL sync (`?vertical=invoicing&status=complete`)
- **Cross-vertical badges** — `verticalSecondary` renders as purple pills on DocCard
- **Pipeline stepper** — Shows which stages have content when a vertical is selected
- **Workflow chains** — Auto-computed on session detail pages, linking related sessions in the same vertical
- **Dark theme** — Matches project design tokens (Niji palette, Inter/JetBrains Mono fonts)

## Key Architecture Decisions

### Tailwind v4 via Vite Plugin

Astro's `@astrojs/tailwind` integration doesn't support Tailwind v4. Used `@tailwindcss/vite` directly in `astro.config.mjs` instead. Design tokens defined in `@theme {}` block in `global.css`.

### Content Config Location

Astro 5 uses `src/content.config.ts` (not `src/content/config.ts`). Uses `glob` loader from `astro/loaders` and `z` from `astro/zod` — not from the `zod` package directly.

### Static Output + Client-Side Filtering

No server adapter. All 50 pages are pre-built HTML. Filtering on the index page uses `<script>` blocks that toggle `display` on card wrappers via `data-*` attributes. URL state synced via `history.replaceState`.

### Pagefind on Session Pages Only

Added `data-pagefind-body` to the `<main>` element of session detail pages. Pagefind only indexes content within those elements, keeping listing/navigation pages out of search results. Tag facets via `data-pagefind-filter`, metadata via `data-pagefind-meta`.

## Migration Process

1. **Scaffolded** Astro project manually (interactive CLI doesn't work in headless environments)
2. **Defined schema** in `src/content.config.ts` with Zod validation
3. **Migrated 23 docs** from HTML to Markdown using 4 parallel agents (~6 docs each)
4. **Built components** using 3 parallel agents (Sidebar+DocCard+Index, Session+Gary+Decisions, Vertical+Pipeline+Workflow)
5. **Added Pagefind** search with dark theme CSS overrides
6. **Added features** — cross-vertical badges, status filtering
7. **Updated CLAUDE.md** — replaced "For Human Docs" section with "Knowledge Base (Astro)"
8. **Cleaned up** — removed `for_human/` (43 files), generator script, updated `.gitignore`

## What Was Deleted

| Item | Lines |
|------|-------|
| `for_human/*.html` (23 session docs) | ~12,000 |
| `for_human/_stage/*.html` (15 stage pages) | ~2,000 |
| `for_human/index.html` (SPA) | 703 |
| `for_human/_template.html` | 547 |
| `for_human/manifest.json` | 534 |
| `for_human/gary-tracker.html` | 130 |
| `scripts/generate-for-human-index.js` | 1,445 |
| **Total** | **~25,000** |

## New Workflow for Future Sessions

Instead of creating HTML files with `data-*` attributes, sessions now create a simple Markdown file:

```text
knowledge-base/src/content/pipelines/YYYY-MM-DD-topic.md
```

With YAML frontmatter validated at build time. Body content is standard Markdown. Build with `npm run kb:build` to verify.

---

## Artifacts

- **Commits**: `ddd3475` (scaffold + docs + UI), `0cafbf4` (search + features + cleanup)
- **Plan**: `memory/astro-migration-plan.md`
