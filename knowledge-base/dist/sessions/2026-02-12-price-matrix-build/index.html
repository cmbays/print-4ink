<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Full implementation of the pricing engine vertical — schemas, editors, Power Grid, sandbox mode, and the useSpreadsheetEditor data grid widget"><title>Price Matrix Build &mdash; Screen Print Pro KB</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/decisions.DGAibQh0.css"></head> <body>  <main class="max-w-[720px] mx-auto px-6 py-12"> <!-- Back link --> <a href="/" class="inline-flex items-center gap-1.5 text-text-muted text-sm hover:text-action transition-colors mb-8"> <span>&larr;</span> Back to Index
</a> <!-- Tag pills --> <div class="flex items-center gap-2 mb-4"> <span class="text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded bg-success/12 text-success"> feature </span><span class="text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded bg-success/12 text-success"> build </span><span class="text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded bg-warning/12 text-warning"> learning </span> </div> <!-- Title --> <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">Price Matrix Build</h1> <!-- Subtitle --> <p class="text-[15px] text-text-secondary leading-relaxed mb-6">Full implementation of the pricing engine vertical — schemas, editors, Power Grid, sandbox mode, and the useSpreadsheetEditor data grid widget</p> <!-- Meta grid --> <div class="border border-border rounded-lg overflow-hidden mb-6"> <div class="grid grid-cols-2"> <!-- Row 1 --> <div class="px-4 py-3 border-b border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Date</div> <div class="text-sm text-text-primary">2026-02-12</div> </div> <div class="px-4 py-3 border-b border-border border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Branch</div> <div class="text-sm"> <code class="font-mono text-xs bg-bg-surface px-1.5 py-0.5 rounded text-action">session/0211-price-matrix-build</code> </div> </div> <!-- Row 2 --> <div class="px-4 py-3 border-b border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Phase</div> <div class="text-sm text-text-primary">Phase 1</div> </div> <div class="px-4 py-3 border-b border-border border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Vertical</div> <div class="text-sm text-text-primary"> <a href="/verticals/price-matrix" class="text-action hover:underline">Price Matrix</a>  </div> </div> <!-- Row 3 --> <div class="px-4 py-3"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Stage</div> <div class="text-sm"> <a href="/verticals/price-matrix/build" class="inline-flex items-center bg-bg-surface text-action text-xs font-medium px-2 py-0.5 rounded hover:bg-action/10 transition-colors"> Build </a> </div> </div> <div class="px-4 py-3 border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Status</div> <div class="text-sm font-medium text-success"> Complete </div> </div> </div> </div> <!-- Workflow chain --> <div class="mb-6"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Workflow Chain</div> <div class="bg-bg-elevated border border-border rounded-lg px-4 py-2"> <div class="overflow-x-auto"><div class="flex items-center gap-1.5 min-w-max py-2"><a href="/sessions/2026-02-10-price-matrix-research" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Price Matrix Vertical Research"><span class="font-semibold">Research</span><span class="opacity-60">&middot;</span><span class="opacity-80">Price Matrix Vertical R…</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-11-price-matrix-breadboard" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Price Matrix Breadboard"><span class="font-semibold">Breadboard</span><span class="opacity-60">&middot;</span><span class="opacity-80">Price Matrix Breadboard</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-12-price-matrix-build" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-action/10 border-action/30 text-action font-medium" title="Price Matrix Build"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Price Matrix Build</span></a></div></div> </div> </div> <!-- Session resume --> <div class="bg-bg-elevated border border-border rounded-lg px-4 py-3 mb-6"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Resume Session</div> <code class="font-mono text-xs text-action select-all">claude --resume c564ffea-778c-43d0-a35f-2bb32431d23b</code> </div> <!-- PR link -->  <!-- Divider --> <hr class="border-t border-border mb-8"> <!-- Body content --> <div class="prose"> <h2 id="at-a-glance">At a Glance</h2>

























<table><thead><tr><th>Stat</th><th>Value</th></tr></thead><tbody><tr><td>Files Changed</td><td>29</td></tr><tr><td>Lines Added</td><td>8,552</td></tr><tr><td>Commits</td><td>10</td></tr><tr><td>Build Phases</td><td>5</td></tr></tbody></table>
<p>The complete Price Matrix vertical built across 5 phases: foundation schemas and pricing engine, three parallel editor builds, advanced features (sandbox, power grid, cost config), cross-vertical integration, and final polish. The crown jewel is <code>useSpreadsheetEditor</code>, a 777-line reusable hook powering the Power Grid’s Excel-like editing UX.</p>
<h2 id="build-timeline">Build Timeline</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>PHASE A — Foundation (db27e22)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  Zod schemas → Pricing engine (568 LOC) → Mock data → Pricing Hub</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PHASE B — Editors (8eb4bf0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  [Parallel] Setup Wizard + Screen Print Editor + DTF Editor</span></span>
<span class="line"><span>  15 new files, +3,672 lines</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PHASE C — Advanced Features (166e9bc)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  [Parallel] Sandbox Mode + Power Grid + Cost Config</span></span>
<span class="line"><span>  6 new files, +1,400 lines</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PHASE D — Integration (c6eca5a)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  [Parallel] Tag-Template Mapper + Matrix Peek Sheet + big.js migration</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PHASE E — Polish (5810ddd)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  Power Grid UX refinements, CodeRabbit review fixes, a11y improvements</span></span></code></pre>
<h2 id="what-was-built">What Was Built</h2>
<h3 id="pricing-hub">Pricing Hub</h3>
<p>Template cards with service type tabs (Screen Print / DTF), search filter, and a “Create New Template” call-to-action. The entry point for all pricing configuration. Each card shows the template name, service type, last-modified date, and active/draft status.</p>
<p><code>/settings/pricing</code></p>
<h3 id="setup-wizard">Setup Wizard</h3>
<p>4-step guided flow: name and service type, quantity tiers, color pricing, review and create. Industry-standard defaults pre-filled at every step (standard break points at 12/24/48/72/144+, $25/screen setup, $0.50/color-hit base rate). A new shop owner can have pricing configured in under 5 minutes.</p>
<h3 id="screen-print-editor">Screen Print Editor</h3>
<p>Simple Mode with 5 editing sections: ColorPricingGrid (quantity tiers x color counts), QuantityTierEditor (add/remove break points), LocationUpchargeEditor (front/back/sleeve/pocket), GarmentTypePricingEditor (t-shirt/hoodie/polo markup), and SetupFeeEditor (per-screen + bulk waiver). Real-time margin indicators (green/yellow/red) on every price cell with cost breakdown tooltips.</p>
<p><code>/settings/pricing/screen-print/[id]</code></p>
<h3 id="dtf-editor">DTF Editor</h3>
<p>DTFSheetTierEditor for sheet-size-based pricing with DTFPricingCalculator for customer discounts and rush fees. Supports multiple sheet sizes (8.5x11 through 24x36), film type surcharges, and volume discount tiers.</p>
<p><code>/settings/pricing/dtf/[id]</code></p>
<h3 id="power-grid">Power Grid</h3>
<p>TanStack Table spreadsheet with inline cell editing, keyboard navigation (arrow keys, Tab, Enter, Escape), cell selection with visual highlight, and column sorting. Toggle between Simple Mode and Power Mode via a switch in the editor header. Built on the <code>useSpreadsheetEditor</code> hook.</p>
<h3 id="sandbox-mode">Sandbox Mode</h3>
<p>Toggle to enter experimental pricing mode. Make changes without affecting live prices. A ComparisonView modal shows side-by-side diff of current vs. proposed values with percentage change indicators. Apply all changes or discard and revert.</p>
<h3 id="cost-configuration-sheet">Cost Configuration Sheet</h3>
<p>Configure garment cost, ink cost per color, and overhead rate. These values feed margin calculations across all price cells in real time. Changes propagate instantly to margin indicators throughout the editor.</p>
<h3 id="tag-template-mapper">Tag-Template Mapper</h3>
<p>Map customer type tags (retail, wholesale, sports-school, corporate, storefront-merch) to pricing templates. When quoting a customer with tag “sports-school”, the school pricing template auto-applies. Configured from the Pricing Hub.</p>
<h3 id="matrix-peek-sheet">Matrix Peek Sheet</h3>
<p>Read-only pricing preview accessible as a slide-in sheet from the Quote Detail page. Shows the pricing matrix relevant to the current quote’s service type and customer tag, with a link to open the full editor.</p>
<h2 id="the-usespreadsheeteditor-widget">The useSpreadsheetEditor Widget</h2>
<p>The crown jewel of the build — a reusable 777-line React hook that powers the Power Grid. It manages all keyboard, mouse, clipboard, and edit state for a TanStack Table-based spreadsheet.</p>
<h3 id="architecture">Architecture</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>React Context (SpreadsheetContext)</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>  +-- selectedCell    — which cell has focus</span></span>
<span class="line"><span>  +-- editingCell     — which cell is in edit mode</span></span>
<span class="line"><span>  +-- editValue       — current input value</span></span>
<span class="line"><span>  +-- handlers        — onCellClick, onCellDblClick, onKeyDown, onBlur</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>PriceCell (extracted component)</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>  Reads state from Context, NOT from column defs</span></span>
<span class="line"><span>  Column defs are module-level and stable (never recreated)</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>TanStack Table</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>  Stable column defs = no cell DOM recreation on state change</span></span></code></pre>
<h3 id="key-patterns">Key Patterns</h3>
<h3 id="1-stable-column-defs">1. Stable Column Defs</h3>
<p><strong>Problem:</strong> Column defs that depend on interaction state cause cell DOM recreation on every keystroke, unmounting the edit input and losing focus.</p>
<p><strong>Fix:</strong> React Context + extracted PriceCell component. Column defs stay module-level and never change.</p>
<p>TanStack Table uses column defs as a dependency for memoization. If the column def array identity changes, all cells re-render from scratch. When interaction state (selectedCell, editValue) was included in column def closures, every keystroke triggered a full table remount.</p>
<h3 id="2-requestanimationframe-race-condition">2. requestAnimationFrame Race Condition</h3>
<p><strong>Problem:</strong> mouseDown schedules rAF to focus the wrapper div. If dblclick fires before the rAF callback, the rAF steals focus from the edit input.</p>
<p><strong>Fix:</strong> Ref mirror (editingCellRef) checked inside the rAF callback. If a cell entered edit mode between mouseDown and rAF execution, the focus call is skipped.</p>
<p>The sequence: mouseDown fires, schedules rAF. dblclick fires (same event chain), enters edit mode, focuses the input. rAF callback runs, calls wrapper.focus(), stealing focus from the input. The ref mirror breaks this cycle.</p>
<h3 id="3-skipnextblur-pattern">3. skipNextBlur Pattern</h3>
<p><strong>Problem:</strong> Keyboard commit (Enter/Tab) triggers a blur event on the input, causing a double-commit.</p>
<p><strong>Fix:</strong> Set skipNextBlur.current = true before the keyboard commit. The blur handler checks this ref and skips its commit logic.</p>
<p>Enter/Tab both commit the edit value and move selection. The commit changes state, which causes the input to unmount, which fires blur. Without the skipNextBlur guard, the value would be committed twice.</p>
<h3 id="4-editinputkeydown-isolation">4. editInputKeyDown Isolation</h3>
<p><strong>Problem:</strong> Keyboard events on the wrapper div interfere with text editing in the input field.</p>
<p><strong>Fix:</strong> Attach editInputKeyDown directly to the input element with e.stopPropagation(). Handles Tab/Enter/Escape/Arrows in edit mode.</p>
<p>The wrapper div handles arrow key navigation for cell selection. When an input is active, arrow keys should move the cursor within the text, not change the selected cell. Stopping propagation at the input level prevents the wrapper handler from seeing these events.</p>
<h3 id="how-to-reuse">How to Reuse</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">  selectedCell</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">editingCell</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">editValue</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  handleCellClick</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">handleCellDoubleClick</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  handleKeyDown</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">handleBlur</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">handleEditChange</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">  setEditingCell</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">setEditValue</span></span>
<span class="line"><span style="color:#E1E4E8">} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> useSpreadsheetEditor</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  data,          </span><span style="color:#6A737D">// T[] — row data</span></span>
<span class="line"><span style="color:#E1E4E8">  columns,       </span><span style="color:#6A737D">// ColumnDef[] — stable, module-level</span></span>
<span class="line"><span style="color:#E1E4E8">  onCellChange,  </span><span style="color:#6A737D">// (rowIndex, colKey, value) => void</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<h2 id="key-learnings">Key Learnings</h2>
<p><strong>Financial arithmetic:</strong> Never use JavaScript floating-point (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) for monetary calculations. IEEE 754 causes silent errors (e.g., <code>0.1 + 0.2 = 0.30000000000000004</code>). Use <code>big.js</code> via the <code>lib/helpers/money.ts</code> wrapper: <code>money()</code>, <code>round2()</code>, <code>toNumber()</code>. Schema invariants use <code>Big.eq()</code> for exact comparison.</p>
<h3 id="tanstack-table-column-def-stability">TanStack Table Column Def Stability</h3>
<p>Column defs that depend on React state cause cell DOM recreation on every render. The entire table remounts, unmounting inputs and losing focus. Solution: React Context for interaction state, extracted cell components that subscribe to context, module-level column defs that never change identity.</p>
<h3 id="requestanimationframe-race-conditions">requestAnimationFrame Race Conditions</h3>
<p>mouseDown + rAF + dblclick is a dangerous sequence. The rAF callback can execute after the dblclick handler has already changed state (e.g., entered edit mode). Always use ref mirrors to check current state inside rAF callbacks rather than relying on the values captured at scheduling time.</p>
<h3 id="parallel-agent-builds">Parallel Agent Builds</h3>
<p>Three agents edited <code>editor.tsx</code> concurrently in Phase B and again in Phase C. This worked because changes were in different sections of the file. Lesson: always identify and document conflict zones before assigning parallel work. If two agents need to touch the same function, serialize them.</p>
<h3 id="radix-tooltip-hover-bugs">Radix Tooltip Hover Bugs</h3>
<p>Adjacent tooltips (like margin indicators in a dense grid) need a single shared <code>&#x3C;TooltipProvider></code> with <code>skipDelayDuration={300}</code>, base <code>sideOffset >= 6</code>, <code>data-[state=closed]:pointer-events-none</code> on content, and <code>pointer-events-none</code> on the arrow. Do NOT use <code>disableHoverableContent</code> — it causes flickering on small targets.</p>
<h3 id="react-19-no-setstate-in-effects">React 19: No setState in Effects</h3>
<p>ESLint now flags <code>useEffect</code> to reset form state when a dialog opens. Instead, have the parent conditionally render the dialog (<code>{showDialog &#x26;&#x26; &#x3C;Dialog />}</code>) so React unmounts/remounts the component, naturally resetting all <code>useState</code> hooks. Cleaner and avoids the flash of stale state.</p>
<h2 id="file-map">File Map</h2>

















































<table><thead><tr><th>File</th><th>Purpose</th></tr></thead><tbody><tr><td><code>lib/schemas/price-matrix.ts</code></td><td>Zod schemas for SP pricing (161 lines)</td></tr><tr><td><code>lib/schemas/dtf-pricing.ts</code></td><td>Zod schemas for DTF pricing (107 lines)</td></tr><tr><td><code>lib/schemas/tag-template-mapping.ts</code></td><td>Tag-to-template mapping schema (23 lines)</td></tr><tr><td><code>lib/pricing-engine.ts</code></td><td>Pure pricing calculation functions (568 lines)</td></tr><tr><td><code>lib/helpers/money.ts</code></td><td>big.js wrapper for safe money math</td></tr><tr><td><code>lib/hooks/useSpreadsheetEditor.ts</code></td><td>Spreadsheet editing hook (777 lines)</td></tr><tr><td><code>app/.../settings/pricing/page.tsx</code></td><td>Pricing Hub page</td></tr><tr><td><code>app/.../pricing/screen-print/[id]/editor.tsx</code></td><td>Screen Print Editor (client component)</td></tr><tr><td><code>app/.../pricing/dtf/[id]/dtf-editor-client.tsx</code></td><td>DTF Editor (client component)</td></tr><tr><td><code>app/.../pricing/_components/</code></td><td>All shared pricing components</td></tr></tbody></table>
<h2 id="pr-and-commits">PR and Commits</h2>

















































<table><thead><tr><th>Hash</th><th>Description</th></tr></thead><tbody><tr><td>db27e22</td><td><strong>Phase A</strong> — Schemas, pricing engine, mock data, hub page</td></tr><tr><td>8eb4bf0</td><td><strong>Phase B</strong> — Setup Wizard, Screen Print and DTF editors (15 files, +3,672 lines)</td></tr><tr><td>166e9bc</td><td><strong>Phase C</strong> — Sandbox Mode, Power Grid, Cost Config (6 files, +1,400 lines)</td></tr><tr><td>c6eca5a</td><td><strong>Phase D</strong> — Tag-Template Mapper, Matrix Peek Sheet, big.js migration</td></tr><tr><td>e95bffc</td><td>Quality gate fixes — lint errors, semantic colors, a11y, empty states</td></tr><tr><td>eba7a95</td><td>Power Grid UX — remove sort, per-cell overrides, selection enhancements</td></tr><tr><td>7f697be</td><td>Configurable max colors, compact header layout</td></tr><tr><td>3e6a095</td><td>Add tooltips to margin legend in Power Grid header</td></tr><tr><td>f204c34</td><td>CodeRabbit review — money helper, schema validation, a11y, guards</td></tr><tr><td>5810ddd</td><td>CodeRabbit round 2 — maxColors consistency, a11y, input validation</td></tr></tbody></table>
<h2 id="next-steps">Next Steps</h2>
<ol>
<li><strong>Matrix Peek from Quote Detail</strong> — Partially built; needs the Quote Detail page to be wired up for full integration testing</li>
<li><strong>Tag-Template Mapping</strong> — Built and functional; needs the Customer Management vertical to test the auto-apply flow during quoting</li>
<li><strong>Quality gate</strong> — Full 15-dimension design audit against the screen audit protocol</li>
<li><strong>User demo with 4Ink</strong> — Walk through the 5-minute setup wizard, margin indicators, what-if sandbox, and Power Grid editing</li>
</ol> </div> <!-- Footer --> <footer class="mt-16 pt-6 border-t border-border"> <p class="text-xs text-text-muted text-center">
Screen Print Pro &mdash; Price Matrix Build &mdash; 2026-02-12 </p> </footer> </main>  </body></html>