<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Single command to create worktrees, tmux sessions, and launch Claude — with Agent Teams integration via tmux hook."><title>work() — Worktree Orchestrator &mdash; Screen Print Pro KB</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/decisions.DGAibQh0.css"></head> <body>  <main class="max-w-[720px] mx-auto px-6 py-12"> <!-- Back link --> <a href="/" class="inline-flex items-center gap-1.5 text-text-muted text-sm hover:text-action transition-colors mb-8"> <span>&larr;</span> Back to Index
</a> <!-- Tag pills --> <div class="flex items-center gap-2 mb-4"> <span class="text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded bg-success/12 text-success"> build </span><span class="text-[11px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded bg-success/12 text-success"> feature </span> </div> <!-- Title --> <h1 class="text-[28px] font-bold tracking-tight leading-tight mb-2">work() — Worktree Orchestrator</h1> <!-- Subtitle --> <p class="text-[15px] text-text-secondary leading-relaxed mb-6">Single command to create worktrees, tmux sessions, and launch Claude — with Agent Teams integration via tmux hook.</p> <!-- Meta grid --> <div class="border border-border rounded-lg overflow-hidden mb-6"> <div class="grid grid-cols-2"> <!-- Row 1 --> <div class="px-4 py-3 border-b border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Date</div> <div class="text-sm text-text-primary">2026-02-10</div> </div> <div class="px-4 py-3 border-b border-border border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Branch</div> <div class="text-sm"> <code class="font-mono text-xs bg-bg-surface px-1.5 py-0.5 rounded text-action">session/0210-worktree-migration</code> </div> </div> <!-- Row 2 --> <div class="px-4 py-3 border-b border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Phase</div> <div class="text-sm text-text-primary">Phase 1</div> </div> <div class="px-4 py-3 border-b border-border border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Vertical</div> <div class="text-sm text-text-primary"> <a href="/verticals/meta" class="text-action hover:underline">Meta</a>  </div> </div> <!-- Row 3 --> <div class="px-4 py-3"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Stage</div> <div class="text-sm"> <a href="/verticals/meta/build" class="inline-flex items-center bg-bg-surface text-action text-xs font-medium px-2 py-0.5 rounded hover:bg-action/10 transition-colors"> Build </a> </div> </div> <div class="px-4 py-3 border-l border-border"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-1">Status</div> <div class="text-sm font-medium text-success"> Complete </div> </div> </div> </div> <!-- Workflow chain --> <div class="mb-6"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Workflow Chain</div> <div class="bg-bg-elevated border border-border rounded-lg px-4 py-2"> <div class="overflow-x-auto"><div class="flex items-center gap-1.5 min-w-max py-2"><a href="/sessions/2026-02-07-shaping-skills" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Shaping Skills Evaluation"><span class="font-semibold">Research</span><span class="opacity-60">&middot;</span><span class="opacity-80">Shaping Skills Evaluati…</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-08-strategic-pivot" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Strategic Pivot: Vertical-by-Vertical"><span class="font-semibold">Impl Plan</span><span class="opacity-60">&middot;</span><span class="opacity-80">Strategic Pivot: Vertic…</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-07-ci-testing" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="CI &#38; Testing Setup"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">CI &amp; Testing Setup</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-07-skills-implementation" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Skills Implementation"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Skills Implementation</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-08-agent-architecture" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Agent Architecture"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Agent Architecture</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-08-vercel-setup" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Vercel Setup with Access Code Protection"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Vercel Setup with Acces…</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-08-breadboarding-skill" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Breadboarding Skill"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Breadboarding Skill</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-10-work-orchestrator" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-action/10 border-action/30 text-action font-medium" title="work() — Worktree Orchestrator"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">work() — Worktree Orche…</span></a><span class="text-text-muted text-[11px] select-none">&rarr;</span><a href="/sessions/2026-02-10-worktree-migration" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[12px] border transition-colors whitespace-nowrap bg-bg-surface border-border text-text-secondary hover:text-text-primary hover:border-action/20" title="Git Worktree Migration + Memory Refactoring"><span class="font-semibold">Build</span><span class="opacity-60">&middot;</span><span class="opacity-80">Git Worktree Migration …</span></a></div></div> </div> </div> <!-- Session resume --> <div class="bg-bg-elevated border border-border rounded-lg px-4 py-3 mb-6"> <div class="text-[11px] font-semibold uppercase tracking-wide text-text-muted mb-2">Resume Session</div> <code class="font-mono text-xs text-action select-all">claude --resume c2b2fb1b-b94a-4b17-bab0-3616c520c716</code> </div> <!-- PR link -->  <!-- Divider --> <hr class="border-t border-border mb-8"> <!-- Body content --> <div class="prose"> <h2 id="why">Why</h2>
<p>Manual worktree setup requires 4-5 commands per session: pull main, create worktree, install deps, find available port, open terminal and launch Claude. There’s no grouping of related sessions, no consistent branch naming, and Agent Teams’ <code>split-window</code> approach destroys tmux layouts at scale (<a href="https://github.com/anthropics/claude-code/issues/23615">#23615</a>).</p>
<h2 id="what-it-does">What It Does</h2>
<p>A single <code>work &#x3C;topic></code> shell function handles everything: worktree creation from main repo, npm install, port scanning, tmux session/window creation, Claude launch, and an <code>after-split-window</code> hook that auto-converts Agent Teams panes into proper windows.</p>

















<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody><tr><td>1</td><td>Command</td></tr><tr><td>~220</td><td>Lines of Bash</td></tr></tbody></table>
<h2 id="ghostty--tmux-architecture">Ghostty + Tmux Architecture</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Ghostty Quick Terminal (hotkey toggle)</span></span>
<span class="line"><span>+- Pane 1 (you split manually)</span></span>
<span class="line"><span>|  +- tmux session: "main"</span></span>
<span class="line"><span>|      +- window: main Claude (planning)</span></span>
<span class="line"><span>|</span></span>
<span class="line"><span>+- Pane 2 (you split manually, Claude gives command)</span></span>
<span class="line"><span>|  +- tmux session: "invoicing-schema"</span></span>
<span class="line"><span>|      +- window: invoicing-schema  &#x3C;- work invoicing-schema</span></span>
<span class="line"><span>|      +- window: invoicing-ui      &#x3C;- Claude runs work (stacked)</span></span>
<span class="line"><span>|      +- window: (auto)            &#x3C;- Agent Teams (hook)</span></span>
<span class="line"><span>|      +- window: (auto)            &#x3C;- Agent Teams (hook)</span></span>
<span class="line"><span>|</span></span>
<span class="line"><span>+- Pane 3 (you split manually)</span></span>
<span class="line"><span>   +- tmux session: "customer-export"</span></span>
<span class="line"><span>       +- window: customer-export  &#x3C;- work customer-export</span></span></code></pre>
<p><strong>Two modes:</strong></p>
<ul>
<li><strong>New workstream</strong> (<code>work &#x3C;topic></code>) → detached tmux session. Claude gives you the command; you attach from a new Ghostty pane.</li>
<li><strong>Related work</strong> (<code>work &#x3C;topic> &#x3C;base></code>) → new window/tab in parent’s tmux session. Claude does this automatically; no pane splitting needed.</li>
<li><strong>Agent Teams</strong> → pane splits auto-convert to windows via <code>after-split-window</code> hook. All agents appear as tabs in the same session.</li>
<li><strong><code>--prompt</code></strong> → seeds the new Claude with an initial task via <code>tmux send-keys</code>.</li>
</ul>
<h2 id="commands-reference">Commands Reference</h2>









































<table><thead><tr><th>Command</th><th>What It Does</th></tr></thead><tbody><tr><td><code>work &#x3C;topic></code></td><td>New workstream: detached tmux session + worktree + Claude</td></tr><tr><td><code>work &#x3C;topic> &#x3C;base></code></td><td>Related work: window in parent’s tmux session + worktree</td></tr><tr><td><code>work &#x3C;topic> --prompt "..."</code></td><td>Seed new Claude with an initial task prompt</td></tr><tr><td><code>work --stack &#x3C;topic></code></td><td>Stack from current branch (auto-detects from $PWD)</td></tr><tr><td><code>work list</code></td><td>Show sessions, windows, worktrees, ports</td></tr><tr><td><code>work focus</code></td><td>Read-only tiled monitor of all windows in current session</td></tr><tr><td><code>work unfocus</code></td><td>Exit focus mode</td></tr><tr><td><code>work clean &#x3C;topic></code></td><td>Remove worktree + tmux + branch (with confirmation)</td></tr></tbody></table>
<h2 id="agent-teams-integration">Agent Teams Integration</h2>
<p>Claude Code’s Agent Teams uses <code>tmux split-window -h</code> for each spawned agent. This is buggy at scale. Our fix:</p>
<ol>
<li>Every <code>work</code>-created tmux session gets an <code>after-split-window</code> hook</li>
<li>When Claude’s TeamCreate splits a pane for an agent, the hook fires</li>
<li><code>break-pane</code> extracts the new pane into its own window (process keeps running)</li>
<li>Each agent becomes a navigable window (<code>Ctrl+b n</code> to cycle)</li>
</ol>
<p>The hook is scoped to <code>work</code>-created sessions only — doesn’t affect other tmux usage.</p>
<h2 id="focus--unfocus">Focus / Unfocus</h2>
<p><code>work focus</code> creates a <strong>separate read-only tmux session</strong> that mirrors each window’s output via <code>tmux capture-pane</code>. The original session and all its windows are completely untouched.</p>
<ul>
<li><code>Ctrl+b z</code> in focus mode zooms one pane for detailed reading</li>
<li><code>Ctrl+b s</code> switches back to the original session for interaction</li>
<li><code>work unfocus</code> kills the focus session and returns</li>
</ul>
<h2 id="workflow-examples">Workflow Examples</h2>
<h3 id="1-new-workstream-you-split-the-ghostty-pane">1. New workstream (you split the Ghostty pane)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># Claude says: "Run this in a new Ghostty pane:"</span></span>
<span class="line"><span>work invoicing-schema --prompt "Build the Zod schemas per docs/strategy/..."</span></span>
<span class="line"><span># Then in a new Ghostty pane:</span></span>
<span class="line"><span>tmux attach -t invoicing-schema</span></span>
<span class="line"><span># Claude is already running with your prompt</span></span></code></pre>
<h3 id="2-related-work-claude-does-this-automatically">2. Related work (Claude does this automatically)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># Claude runs this from within the invoicing-schema session:</span></span>
<span class="line"><span>work invoicing-ui session/0210-invoicing-schema --prompt "Build UI components"</span></span>
<span class="line"><span># New tab appears in the invoicing-schema tmux session</span></span>
<span class="line"><span># Navigate: Ctrl+b n (next) or Ctrl+b w (tree)</span></span></code></pre>
<h3 id="3-agent-teams-fully-automatic">3. Agent Teams (fully automatic)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># Inside a work-created session, Claude uses TeamCreate</span></span>
<span class="line"><span># TeamCreate splits panes -> hook converts to windows</span></span>
<span class="line"><span># All agents appear as tabs: Ctrl+b n to cycle</span></span>
<span class="line"><span>work focus                             # Monitor all agents tiled</span></span></code></pre>
<h3 id="4-full-example--workstream--stacked--agent-teams">4. Full example — workstream + stacked + Agent Teams</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># You: split Ghostty pane, run:</span></span>
<span class="line"><span>work invoicing-schema</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Claude spawns related work (new tabs in same session):</span></span>
<span class="line"><span>work invoicing-ui session/0210-invoicing-schema --prompt "Build UI"</span></span>
<span class="line"><span>work invoicing-tests session/0210-invoicing-schema --prompt "Write tests"</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Claude also uses TeamCreate for parallel agents (auto-converted to tabs)</span></span>
<span class="line"><span># Session now has: invoicing-schema, invoicing-ui, invoicing-tests, agent-1, agent-2</span></span>
<span class="line"><span>work focus                             # See all 5 tiled</span></span></code></pre>
<h2 id="tmux-navigation-cheatsheet">Tmux Navigation Cheatsheet</h2>

































<table><thead><tr><th>Shortcut</th><th>Action</th></tr></thead><tbody><tr><td><code>Ctrl+b s</code></td><td>Session picker (all features)</td></tr><tr><td><code>Ctrl+b n</code></td><td>Next window (cycle agents)</td></tr><tr><td><code>Ctrl+b p</code></td><td>Previous window</td></tr><tr><td><code>Ctrl+b w</code></td><td>Window tree (all sessions + windows)</td></tr><tr><td><code>Ctrl+b z</code></td><td>Zoom pane (in focus view)</td></tr><tr><td><code>work unfocus</code></td><td>Exit focus mode</td></tr></tbody></table>
<h2 id="setup">Setup</h2>
<p>One-time setup (already done):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># Added to ~/.zshrc</span></span>
<span class="line"><span>[[ -f ~/Github/print-4ink/scripts/work.sh ]] &#x26;&#x26; source ~/Github/print-4ink/scripts/work.sh</span></span></code></pre>
<p>The script is sourced (not executed), so it defines the <code>work()</code> function in your shell. Uses absolute paths internally, works from any directory.</p>
<h2 id="safety-guarantees">Safety Guarantees</h2>
<ul>
<li>Always operates from main repo (<code>~/Github/print-4ink</code>), never from <code>$PWD</code></li>
<li>Pulls latest main before branching (skips for stacked PRs)</li>
<li>Checks branch doesn’t already exist before creating</li>
<li>Enforces max 6 worktrees with warning</li>
<li>Port scanning finds first available port (3001-3010)</li>
<li><code>work clean</code> requires <code>y</code> confirmation before destructive actions</li>
</ul> </div> <!-- Footer --> <footer class="mt-16 pt-6 border-t border-border"> <p class="text-xs text-text-muted text-center">
Screen Print Pro &mdash; work() — Worktree Orchestrator &mdash; 2026-02-10 </p> </footer> </main>  </body></html>