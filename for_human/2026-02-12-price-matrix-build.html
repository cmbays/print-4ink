<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Matrix Build &mdash; Screen Print Pro</title>
  <style>
    :root {
      --bg-primary: #09090b;
      --bg-elevated: #18181b;
      --bg-surface: #1c1c1f;
      --text-primary: rgba(255,255,255,0.87);
      --text-secondary: rgba(255,255,255,0.60);
      --text-muted: rgba(255,255,255,0.38);
      --action: #22d3ee;
      --success: #34d399;
      --error: #f87171;
      --warning: #fbbf24;
      --border: rgba(255,255,255,0.08);
      --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-ui);
      line-height: 1.6;
      padding: 48px 24px;
    }

    .container { max-width: 720px; margin: 0 auto; }

    /* --- TOP NAV --- */
    .top-nav { margin-bottom: 24px; }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      transition: all 0.15s ease;
    }

    .back-btn:hover {
      color: var(--action);
      border-color: rgba(34, 211, 238, 0.3);
      text-decoration: none;
    }

    /* --- HEADER --- */
    header { margin-bottom: 32px; }

    .tag-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: 4px;
    }

    .tag-feature,
    .tag-build    { background: rgba(52, 211, 153, 0.12); color: var(--success); }
    .tag-plan     { background: rgba(34, 211, 238, 0.12); color: var(--action); }
    .tag-decision,
    .tag-learning { background: rgba(251, 191, 36, 0.12); color: var(--warning); }
    .tag-research { background: rgba(167, 139, 250, 0.12); color: #a78bfa; }

    h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 20px;
    }

    /* --- META GRID --- */
    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .meta-item {
      background: var(--bg-elevated);
      padding: 12px 16px;
    }

    .meta-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .meta-value {
      font-size: 13px;
      color: var(--text-primary);
    }

    /* --- SESSION RESUME --- */
    .session-resume {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .session-resume code {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--action);
      user-select: all;
      cursor: pointer;
    }

    /* --- RELATED SESSIONS --- */
    .related-nav { margin-bottom: 32px; }

    .related-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .related-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .related-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      transition: all 0.15s ease;
    }

    .related-link:hover {
      color: var(--action);
      border-color: rgba(34, 211, 238, 0.3);
      text-decoration: none;
    }

    .related-link .related-desc {
      color: var(--text-muted);
      font-size: 11px;
    }

    /* --- DIVIDER --- */
    .header-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0 0 32px 0;
    }

    /* --- BODY CONTENT --- */
    h2 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-top: 40px;
      margin-bottom: 16px;
    }

    h3 {
      font-size: 16px;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 8px;
    }

    p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 12px;
    }

    a { color: var(--action); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .card-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .card-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .card-route {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--action);
      margin-top: 8px;
    }

    ul, ol { padding-left: 20px; margin-bottom: 16px; }
    li { font-size: 14px; color: var(--text-secondary); margin-bottom: 6px; }
    li strong { color: var(--text-primary); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
      font-size: 13px;
    }

    th {
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
    }

    td:first-child { color: var(--text-primary); }

    code {
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-surface);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--action);
    }

    .code-block {
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 16px;
      margin-top: 8px;
      margin-bottom: 16px;
      color: var(--text-primary);
      user-select: all;
      cursor: pointer;
      white-space: pre;
      overflow-x: auto;
      line-height: 1.6;
    }

    .code-block .keyword { color: var(--action); }
    .code-block .type { color: #a78bfa; }
    .code-block .comment { color: var(--text-muted); }
    .code-block .string { color: var(--success); }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 32px 0;
    }

    /* --- STAT GRID --- */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--action);
    }

    .stat-value-success { color: var(--success); }
    .stat-value-warning { color: var(--warning); }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
    }

    /* --- FLOW DIAGRAM --- */
    .flow-diagram {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.8;
      color: var(--text-secondary);
      white-space: pre;
      overflow-x: auto;
    }

    .flow-diagram .highlight { color: var(--action); font-weight: 600; }
    .flow-diagram .parallel { color: var(--success); }
    .flow-diagram .dim { color: var(--text-muted); }
    .flow-diagram .commit { color: var(--warning); font-weight: 600; }

    /* --- PARALLEL / SEQUENTIAL BLOCKS --- */
    .parallel-block {
      background: rgba(52, 211, 153, 0.06);
      border: 1px solid rgba(52, 211, 153, 0.15);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 12px;
    }

    .parallel-block .card-label {
      color: var(--success);
    }

    .sequential-block {
      background: rgba(34, 211, 238, 0.06);
      border: 1px solid rgba(34, 211, 238, 0.15);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 12px;
    }

    .sequential-block .card-label {
      color: var(--action);
    }

    /* --- CALLOUT --- */
    .callout {
      background: var(--bg-elevated);
      border-left: 3px solid var(--action);
      border-radius: 0 8px 8px 0;
      padding: 16px 20px;
      margin-bottom: 16px;
    }

    .callout-warning { border-left-color: var(--warning); }
    .callout-success { border-left-color: var(--success); }
    .callout-error { border-left-color: var(--error); }
    .callout p { margin-bottom: 0; }
    .callout strong { color: var(--text-primary); }

    /* --- ARCHITECTURE DIAGRAM --- */
    .arch-diagram {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px 24px;
      margin-bottom: 16px;
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.7;
      color: var(--text-secondary);
      white-space: pre;
      overflow-x: auto;
    }

    .arch-diagram .layer { color: var(--action); font-weight: 600; }
    .arch-diagram .component { color: var(--text-primary); }
    .arch-diagram .arrow { color: var(--text-muted); }
    .arch-diagram .warn { color: var(--warning); }
    .arch-diagram .good { color: var(--success); }

    /* --- COMMIT LIST --- */
    .commit-list {
      list-style: none;
      padding: 0;
    }

    .commit-list li {
      display: flex;
      gap: 12px;
      align-items: baseline;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .commit-list li:last-child { border-bottom: none; }

    .commit-hash {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--warning);
      font-weight: 600;
      min-width: 64px;
      flex-shrink: 0;
    }

    .commit-msg {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .commit-msg strong {
      color: var(--text-primary);
    }

    /* --- PATTERN CARD --- */
    .pattern-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .pattern-card .pattern-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .pattern-card .pattern-problem {
      font-size: 12px;
      color: var(--error);
      margin-bottom: 6px;
    }

    .pattern-card .pattern-fix {
      font-size: 12px;
      color: var(--success);
      margin-bottom: 8px;
    }

    .pattern-card .pattern-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    footer {
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- ========== TOP NAV ========== -->
    <nav class="top-nav">
      <a class="back-btn" href="index.html">&larr; Back to Index</a>
    </nav>

    <!-- ========== HEADER ========== -->
    <header>
      <div class="tag-row">
        <span class="tag tag-feature">Feature</span>
        <span class="tag tag-build">Build</span>
        <span class="tag tag-learning">Learning</span>
      </div>

      <h1>Price Matrix Build</h1>
      <p class="subtitle">Full implementation of the pricing engine vertical &mdash; schemas, editors, Power Grid, sandbox mode, and the useSpreadsheetEditor data grid widget</p>

      <div class="meta-grid">
        <div class="meta-item">
          <span class="meta-label">Date</span>
          <span class="meta-value">2026-02-12</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Branch</span>
          <span class="meta-value"><code>session/0211-price-matrix-build</code></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Phase</span>
          <span class="meta-value">Phase 1 &mdash; Mockup</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Vertical</span>
          <span class="meta-value">Price Matrix</span>
        </div>
      </div>

      <div class="session-resume">
        <span class="meta-label">Resume Session</span>
        <code>claude --resume c564ffea-778c-43d0-a35f-2bb32431d23b</code>
      </div>
    </header>

    <!-- ========== RELATED SESSIONS ========== -->
    <nav class="related-nav">
      <span class="related-label">Related Sessions</span>
      <div class="related-links">
        <a class="related-link" href="2026-02-10-price-matrix-research.html">
          &larr; Research <span class="related-desc">&mdash; Market analysis, 80+ sources, competitor ratings</span>
        </a>
        <a class="related-link" href="2026-02-11-price-matrix-breadboard.html">
          &larr; Breadboard <span class="related-desc">&mdash; Affordance map, wiring, build order</span>
        </a>
      </div>
    </nav>

    <hr class="header-divider">

    <!-- ========== BODY CONTENT ========== -->

    <!-- AT A GLANCE -->
    <h2>At a Glance</h2>

    <div class="stat-grid">
      <div class="stat">
        <div class="stat-value">29</div>
        <div class="stat-label">Files Changed</div>
      </div>
      <div class="stat">
        <div class="stat-value stat-value-success">8,552</div>
        <div class="stat-label">Lines Added</div>
      </div>
      <div class="stat">
        <div class="stat-value stat-value-warning">10</div>
        <div class="stat-label">Commits</div>
      </div>
      <div class="stat">
        <div class="stat-value">5</div>
        <div class="stat-label">Build Phases</div>
      </div>
    </div>

    <p>The complete Price Matrix vertical built across 5 phases: foundation schemas and pricing engine, three parallel editor builds, advanced features (sandbox, power grid, cost config), cross-vertical integration, and final polish. The crown jewel is <code>useSpreadsheetEditor</code>, a 777-line reusable hook powering the Power Grid's Excel-like editing UX.</p>

    <!-- BUILD TIMELINE -->
    <h2>Build Timeline</h2>

    <div class="flow-diagram"><span class="dim">PHASE A &mdash; Foundation</span> <span class="commit">(db27e22)</span>

  <span class="highlight">Zod schemas</span> &rarr; <span class="highlight">Pricing engine</span> (568 LOC) &rarr; <span class="highlight">Mock data</span> &rarr; <span class="highlight">Pricing Hub</span>

<span class="dim">PHASE B &mdash; Editors</span> <span class="commit">(8eb4bf0)</span>

  <span class="parallel">[Parallel]</span> Setup Wizard + Screen Print Editor + DTF Editor
  15 new files, +3,672 lines

<span class="dim">PHASE C &mdash; Advanced Features</span> <span class="commit">(166e9bc)</span>

  <span class="parallel">[Parallel]</span> Sandbox Mode + Power Grid + Cost Config
  6 new files, +1,400 lines

<span class="dim">PHASE D &mdash; Integration</span> <span class="commit">(c6eca5a)</span>

  <span class="parallel">[Parallel]</span> Tag-Template Mapper + Matrix Peek Sheet + big.js migration

<span class="dim">PHASE E &mdash; Polish</span> <span class="commit">(5810ddd)</span>

  Power Grid UX refinements, CodeRabbit review fixes, a11y improvements</div>

    <!-- WHAT WAS BUILT -->
    <h2>What Was Built</h2>

    <div class="card">
      <div class="card-label">Hub Page</div>
      <div class="card-title">Pricing Hub</div>
      <div class="card-desc">Template cards with service type tabs (Screen Print / DTF), search filter, and a "Create New Template" call-to-action. The entry point for all pricing configuration. Each card shows the template name, service type, last-modified date, and active/draft status.</div>
      <div class="card-route">/settings/pricing</div>
    </div>

    <div class="card">
      <div class="card-label">Guided Flow</div>
      <div class="card-title">Setup Wizard</div>
      <div class="card-desc">4-step guided flow: name and service type, quantity tiers, color pricing, review and create. Industry-standard defaults pre-filled at every step (standard break points at 12/24/48/72/144+, $25/screen setup, $0.50/color-hit base rate). A new shop owner can have pricing configured in under 5 minutes.</div>
    </div>

    <div class="card">
      <div class="card-label">Full Editor</div>
      <div class="card-title">Screen Print Editor</div>
      <div class="card-desc">Simple Mode with 5 editing sections: ColorPricingGrid (quantity tiers x color counts), QuantityTierEditor (add/remove break points), LocationUpchargeEditor (front/back/sleeve/pocket), GarmentTypePricingEditor (t-shirt/hoodie/polo markup), and SetupFeeEditor (per-screen + bulk waiver). Real-time margin indicators (green/yellow/red) on every price cell with cost breakdown tooltips.</div>
      <div class="card-route">/settings/pricing/screen-print/[id]</div>
    </div>

    <div class="card">
      <div class="card-label">Full Editor</div>
      <div class="card-title">DTF Editor</div>
      <div class="card-desc">DTFSheetTierEditor for sheet-size-based pricing with DTFPricingCalculator for customer discounts and rush fees. Supports multiple sheet sizes (8.5x11 through 24x36), film type surcharges, and volume discount tiers.</div>
      <div class="card-route">/settings/pricing/dtf/[id]</div>
    </div>

    <div class="card">
      <div class="card-label">Advanced Feature</div>
      <div class="card-title">Power Grid</div>
      <div class="card-desc">TanStack Table spreadsheet with inline cell editing, keyboard navigation (arrow keys, Tab, Enter, Escape), cell selection with visual highlight, and column sorting. Toggle between Simple Mode and Power Mode via a switch in the editor header. Built on the <code>useSpreadsheetEditor</code> hook.</div>
    </div>

    <div class="card">
      <div class="card-label">Advanced Feature</div>
      <div class="card-title">Sandbox Mode</div>
      <div class="card-desc">Toggle to enter experimental pricing mode. Make changes without affecting live prices. A ComparisonView modal shows side-by-side diff of current vs. proposed values with percentage change indicators. Apply all changes or discard and revert.</div>
    </div>

    <div class="card">
      <div class="card-label">Slide-in Panel</div>
      <div class="card-title">Cost Configuration Sheet</div>
      <div class="card-desc">Configure garment cost, ink cost per color, and overhead rate. These values feed margin calculations across all price cells in real time. Changes propagate instantly to margin indicators throughout the editor.</div>
    </div>

    <div class="card">
      <div class="card-label">Integration</div>
      <div class="card-title">Tag-Template Mapper</div>
      <div class="card-desc">Map customer type tags (retail, wholesale, sports-school, corporate, storefront-merch) to pricing templates. When quoting a customer with tag "sports-school", the school pricing template auto-applies. Configured from the Pricing Hub.</div>
    </div>

    <div class="card">
      <div class="card-label">Integration</div>
      <div class="card-title">Matrix Peek Sheet</div>
      <div class="card-desc">Read-only pricing preview accessible as a slide-in sheet from the Quote Detail page. Shows the pricing matrix relevant to the current quote's service type and customer tag, with a link to open the full editor.</div>
    </div>

    <!-- THE useSpreadsheetEditor WIDGET -->
    <h2>The useSpreadsheetEditor Widget</h2>

    <p>The crown jewel of the build &mdash; a reusable 777-line React hook that powers the Power Grid. It manages all keyboard, mouse, clipboard, and edit state for a TanStack Table-based spreadsheet.</p>

    <h3>Architecture</h3>

    <div class="arch-diagram"><span class="layer">React Context (SpreadsheetContext)</span>
  <span class="arrow">|</span>
  <span class="arrow">+--</span> <span class="component">selectedCell</span>    <span class="arrow">&mdash;</span> which cell has focus
  <span class="arrow">+--</span> <span class="component">editingCell</span>     <span class="arrow">&mdash;</span> which cell is in edit mode
  <span class="arrow">+--</span> <span class="component">editValue</span>       <span class="arrow">&mdash;</span> current input value
  <span class="arrow">+--</span> <span class="component">handlers</span>        <span class="arrow">&mdash;</span> onCellClick, onCellDblClick, onKeyDown, onBlur
  <span class="arrow">|</span>
<span class="layer">PriceCell (extracted component)</span>
  <span class="arrow">|</span>
  <span class="good">Reads state from Context, NOT from column defs</span>
  <span class="good">Column defs are module-level and stable (never recreated)</span>
  <span class="arrow">|</span>
<span class="layer">TanStack Table</span>
  <span class="arrow">|</span>
  <span class="good">Stable column defs = no cell DOM recreation on state change</span></div>

    <h3>Key Patterns</h3>

    <div class="pattern-card">
      <div class="pattern-name">1. Stable Column Defs</div>
      <div class="pattern-problem">Problem: Column defs that depend on interaction state cause cell DOM recreation on every keystroke, unmounting the edit input and losing focus.</div>
      <div class="pattern-fix">Fix: React Context + extracted PriceCell component. Column defs stay module-level and never change.</div>
      <div class="pattern-desc">TanStack Table uses column defs as a dependency for memoization. If the column def array identity changes, all cells re-render from scratch. When interaction state (selectedCell, editValue) was included in column def closures, every keystroke triggered a full table remount.</div>
    </div>

    <div class="pattern-card">
      <div class="pattern-name">2. requestAnimationFrame Race Condition</div>
      <div class="pattern-problem">Problem: mouseDown schedules rAF to focus the wrapper div. If dblclick fires before the rAF callback, the rAF steals focus from the edit input.</div>
      <div class="pattern-fix">Fix: Ref mirror (editingCellRef) checked inside the rAF callback. If a cell entered edit mode between mouseDown and rAF execution, the focus call is skipped.</div>
      <div class="pattern-desc">The sequence: mouseDown fires, schedules rAF. dblclick fires (same event chain), enters edit mode, focuses the input. rAF callback runs, calls wrapper.focus(), stealing focus from the input. The ref mirror breaks this cycle.</div>
    </div>

    <div class="pattern-card">
      <div class="pattern-name">3. skipNextBlur Pattern</div>
      <div class="pattern-problem">Problem: Keyboard commit (Enter/Tab) triggers a blur event on the input, causing a double-commit.</div>
      <div class="pattern-fix">Fix: Set skipNextBlur.current = true before the keyboard commit. The blur handler checks this ref and skips its commit logic.</div>
      <div class="pattern-desc">Enter/Tab both commit the edit value and move selection. The commit changes state, which causes the input to unmount, which fires blur. Without the skipNextBlur guard, the value would be committed twice.</div>
    </div>

    <div class="pattern-card">
      <div class="pattern-name">4. editInputKeyDown Isolation</div>
      <div class="pattern-problem">Problem: Keyboard events on the wrapper div interfere with text editing in the input field.</div>
      <div class="pattern-fix">Fix: Attach editInputKeyDown directly to the input element with e.stopPropagation(). Handles Tab/Enter/Escape/Arrows in edit mode.</div>
      <div class="pattern-desc">The wrapper div handles arrow key navigation for cell selection. When an input is active, arrow keys should move the cursor within the text, not change the selected cell. Stopping propagation at the input level prevents the wrapper handler from seeing these events.</div>
    </div>

    <h3>How to Reuse</h3>

    <div class="code-block"><span class="keyword">const</span> {
  selectedCell, editingCell, editValue,
  handleCellClick, handleCellDoubleClick,
  handleKeyDown, handleBlur, handleEditChange,
  setEditingCell, setEditValue
} = <span class="keyword">useSpreadsheetEditor</span>({
  data,          <span class="comment">// T[] &mdash; row data</span>
  columns,       <span class="comment">// ColumnDef[] &mdash; stable, module-level</span>
  onCellChange,  <span class="comment">// (rowIndex, colKey, value) => void</span>
})</div>

    <!-- KEY LEARNINGS -->
    <h2>Key Learnings</h2>

    <div class="callout callout-error">
      <p><strong>Financial arithmetic:</strong> Never use JavaScript floating-point (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) for monetary calculations. IEEE 754 causes silent errors (e.g., <code>0.1 + 0.2 = 0.30000000000000004</code>). Use <code>big.js</code> via the <code>lib/helpers/money.ts</code> wrapper: <code>money()</code>, <code>round2()</code>, <code>toNumber()</code>. Schema invariants use <code>Big.eq()</code> for exact comparison.</p>
    </div>

    <div class="card">
      <div class="card-title">TanStack Table Column Def Stability</div>
      <div class="card-desc">Column defs that depend on React state cause cell DOM recreation on every render. The entire table remounts, unmounting inputs and losing focus. Solution: React Context for interaction state, extracted cell components that subscribe to context, module-level column defs that never change identity.</div>
    </div>

    <div class="card">
      <div class="card-title">requestAnimationFrame Race Conditions</div>
      <div class="card-desc">mouseDown + rAF + dblclick is a dangerous sequence. The rAF callback can execute after the dblclick handler has already changed state (e.g., entered edit mode). Always use ref mirrors to check current state inside rAF callbacks rather than relying on the values captured at scheduling time.</div>
    </div>

    <div class="card">
      <div class="card-title">Parallel Agent Builds</div>
      <div class="card-desc">Three agents edited <code>editor.tsx</code> concurrently in Phase B and again in Phase C. This worked because changes were in different sections of the file. Lesson: always identify and document conflict zones before assigning parallel work. If two agents need to touch the same function, serialize them.</div>
    </div>

    <div class="card">
      <div class="card-title">Radix Tooltip Hover Bugs</div>
      <div class="card-desc">Adjacent tooltips (like margin indicators in a dense grid) need a single shared <code>&lt;TooltipProvider&gt;</code> with <code>skipDelayDuration={300}</code>, base <code>sideOffset &gt;= 6</code>, <code>data-[state=closed]:pointer-events-none</code> on content, and <code>pointer-events-none</code> on the arrow. Do NOT use <code>disableHoverableContent</code> &mdash; it causes flickering on small targets.</div>
    </div>

    <div class="card">
      <div class="card-title">React 19: No setState in Effects</div>
      <div class="card-desc">ESLint now flags <code>useEffect</code> to reset form state when a dialog opens. Instead, have the parent conditionally render the dialog (<code>{showDialog &amp;&amp; &lt;Dialog /&gt;}</code>) so React unmounts/remounts the component, naturally resetting all <code>useState</code> hooks. Cleaner and avoids the flash of stale state.</div>
    </div>

    <!-- FILE MAP -->
    <h2>File Map</h2>

    <table>
      <thead>
        <tr>
          <th>File</th>
          <th>Purpose</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>lib/schemas/price-matrix.ts</code></td>
          <td>Zod schemas for SP pricing (161 lines)</td>
        </tr>
        <tr>
          <td><code>lib/schemas/dtf-pricing.ts</code></td>
          <td>Zod schemas for DTF pricing (107 lines)</td>
        </tr>
        <tr>
          <td><code>lib/schemas/tag-template-mapping.ts</code></td>
          <td>Tag-to-template mapping schema (23 lines)</td>
        </tr>
        <tr>
          <td><code>lib/pricing-engine.ts</code></td>
          <td>Pure pricing calculation functions (568 lines)</td>
        </tr>
        <tr>
          <td><code>lib/helpers/money.ts</code></td>
          <td>big.js wrapper for safe money math</td>
        </tr>
        <tr>
          <td><code>lib/hooks/useSpreadsheetEditor.ts</code></td>
          <td>Spreadsheet editing hook (777 lines)</td>
        </tr>
        <tr>
          <td><code>app/.../settings/pricing/page.tsx</code></td>
          <td>Pricing Hub page</td>
        </tr>
        <tr>
          <td><code>app/.../pricing/screen-print/[id]/editor.tsx</code></td>
          <td>Screen Print Editor (client component)</td>
        </tr>
        <tr>
          <td><code>app/.../pricing/dtf/[id]/dtf-editor-client.tsx</code></td>
          <td>DTF Editor (client component)</td>
        </tr>
        <tr>
          <td><code>app/.../pricing/_components/</code></td>
          <td>All shared pricing components</td>
        </tr>
      </tbody>
    </table>

    <!-- PR & COMMITS -->
    <h2>PR and Commits</h2>

    <ul class="commit-list">
      <li>
        <span class="commit-hash">db27e22</span>
        <span class="commit-msg"><strong>Phase A</strong> &mdash; Schemas, pricing engine, mock data, hub page</span>
      </li>
      <li>
        <span class="commit-hash">8eb4bf0</span>
        <span class="commit-msg"><strong>Phase B</strong> &mdash; Setup Wizard, Screen Print and DTF editors (15 files, +3,672 lines)</span>
      </li>
      <li>
        <span class="commit-hash">166e9bc</span>
        <span class="commit-msg"><strong>Phase C</strong> &mdash; Sandbox Mode, Power Grid, Cost Config (6 files, +1,400 lines)</span>
      </li>
      <li>
        <span class="commit-hash">c6eca5a</span>
        <span class="commit-msg"><strong>Phase D</strong> &mdash; Tag-Template Mapper, Matrix Peek Sheet, big.js migration</span>
      </li>
      <li>
        <span class="commit-hash">e95bffc</span>
        <span class="commit-msg">Quality gate fixes &mdash; lint errors, semantic colors, a11y, empty states</span>
      </li>
      <li>
        <span class="commit-hash">eba7a95</span>
        <span class="commit-msg">Power Grid UX &mdash; remove sort, per-cell overrides, selection enhancements</span>
      </li>
      <li>
        <span class="commit-hash">7f697be</span>
        <span class="commit-msg">Configurable max colors, compact header layout</span>
      </li>
      <li>
        <span class="commit-hash">3e6a095</span>
        <span class="commit-msg">Add tooltips to margin legend in Power Grid header</span>
      </li>
      <li>
        <span class="commit-hash">f204c34</span>
        <span class="commit-msg">CodeRabbit review &mdash; money helper, schema validation, a11y, guards</span>
      </li>
      <li>
        <span class="commit-hash">5810ddd</span>
        <span class="commit-msg">CodeRabbit round 2 &mdash; maxColors consistency, a11y, input validation</span>
      </li>
    </ul>

    <!-- NEXT STEPS -->
    <h2>Next Steps</h2>

    <ol>
      <li><strong>Matrix Peek from Quote Detail</strong> &mdash; Partially built; needs the Quote Detail page to be wired up for full integration testing</li>
      <li><strong>Tag-Template Mapping</strong> &mdash; Built and functional; needs the Customer Management vertical to test the auto-apply flow during quoting</li>
      <li><strong>Quality gate</strong> &mdash; Full 15-dimension design audit against the screen audit protocol</li>
      <li><strong>User demo with 4Ink</strong> &mdash; Walk through the 5-minute setup wizard, margin indicators, what-if sandbox, and Power Grid editing</li>
    </ol>

    <footer>
      Screen Print Pro &mdash; Price Matrix Build &mdash; 2026-02-12
    </footer>
  </div>
</body>
</html>
