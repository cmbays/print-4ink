# Session Prompt: Pipeline Architecture — Streams A, B, C

## Context

You are continuing the **Pipeline Architecture Redesign** (#192). Waves 1-2 (Stream D: Work Orchestrator) are complete and merged. PR #286 delivered all execution commands (`work define/start/build/end/cooldown/status`), stage gates, and `--auto` mode.

The remaining work is Streams A, B, and C — config migration, KB schema update, and KB page updates. These form a dependency chain: **A → B → C**.

## What Was Already Done (verify before starting)

Some Stream A work may have been completed in earlier sessions. Before building anything, **validate the current state**:

```bash
# Check if these files exist / have been updated
cat config/pipeline-types.json    # Should exist — was it renamed from workflows.json?
cat config/stages.json            # Check if slugs are already short-form
cat config/verticals.json         # Should be ELIMINATED — does it still exist?
cat config/products.json          # Should exist (from #190)
cat config/tools.json             # Should exist (from #190)

# Check what imports verticals.json
rg "verticals" --type ts --type json -l
rg "workflows.json" -l

# Check KB schema current state
cat knowledge-base/src/content.config.ts

# Check KB pipeline page
ls knowledge-base/src/pages/pipeline/
```

Read `gh issue view 192 --repo cmbays/print-4ink` for the full checklist to cross-reference.

## Stream A: Config Migration

### Tasks

1. **Rename `config/workflows.json` → `config/pipeline-types.json`** (if not already done)
   - Update ALL imports/references across the codebase
   - `scripts/lib/pipeline-entity.sh` already uses `_pipeline_types_config()` pointing to `pipeline-types.json`

2. **Update `config/stages.json`** — ensure slugs match the 8 canonical stages:
   - `research`, `interview`, `shape`, `breadboard`, `plan`, `build`, `review`, `wrap-up`
   - Add `shape` stage if missing (between interview and breadboard)
   - Remove stale entries (`polish`, `learnings`) if they exist

3. **Eliminate `config/verticals.json`** — update all imports/references
   - Pipeline names are free text now, not config-backed enums
   - Any code that imports verticals.json needs to be updated
   - KB schema likely references this — will be addressed in Stream B

4. **Update all consumers** of these config files:
   - `knowledge-base/src/content.config.ts` (KB schema)
   - Any KB UI components that import config
   - `scripts/work.sh` and `scripts/lib/pipeline-*.sh`
   - Any other TypeScript/shell files

## Stream B: KB Schema Migration

### Tasks

1. **Update `knowledge-base/src/content.config.ts`**:
   - Change `pipeline` field (currently an enum from verticals.json) → `pipelineName` (free text string)
   - Add optional `pipelineId` field (string, format: `YYYYMMDD-topic`)
   - Update `stage` enum to use short slugs from updated stages.json
   - Remove any imports of eliminated config files

2. **Migrate ~60 existing frontmatter files** in `knowledge-base/src/content/sessions/`:
   - Replace `vertical: ENUM_VALUE` → `pipelineName: "human-readable-name"` (or appropriate mapping)
   - Update `stage:` values to new short slugs if they changed
   - Validate all files pass schema: `npm run kb:build`

3. **Mapping strategy for existing verticals → pipeline names**:
   - Each old vertical enum value needs a human-readable pipeline name
   - e.g., `quoting` → `"Quoting"`, `garments` → `"Garment Catalog"`, `dashboard` → `"Dashboard"`, etc.
   - Document the mapping before applying

## Stream C: KB Page Updates

### Tasks

1. **Update `[pipeline].astro`** route to derive from unique `pipelineName` values (not enum)
2. **Update index page** pipeline filters to use dynamic values instead of hardcoded enum
3. **Update `lib/utils.ts`** label/display functions for new field names
4. **Update any components** that reference the old `vertical` or `pipeline` field names

## Parallelization Strategy

### Phase 1: Audit & Plan (serial, ~10 min)

- Read all config files, KB schema, and KB pages
- Identify exact current state (what's already done vs remaining)
- Map old vertical enum values → new pipeline names
- Count files needing migration

### Phase 2: Stream A (serial, foundation)

- Config file changes
- This is the smallest stream but blocks everything else

### Phase 3: Streams B + C (parallelizable after A)

Once config is stable, B and C can be **partially parallelized**:

- **Agent 1 (Stream B - Schema + Migration)**: Update content.config.ts, then migrate all ~60 frontmatter files
- **Agent 2 (Stream C - KB Pages)**: Update astro pages, index filters, utils — can work against the NEW schema types even while migration is in progress, as long as the schema is committed first

The key dependency: Stream B's schema change must be committed before Stream C's page updates can reference the new field names. But the ~60 file migration (bulk of Stream B) can run in parallel with Stream C's page work.

### Suggested parallelization:

```
Phase 1: Audit (you, serial)
Phase 2: Stream A config changes (you, serial)
Phase 3a: Stream B schema update + commit (you, serial)
Phase 3b: Stream B file migration (agent 1) || Stream C pages (agent 2)
Phase 4: Verify: npm run kb:build
```

## Verification

After all streams complete:

```bash
# Config files correct
cat config/pipeline-types.json   # exists, correct stages
cat config/stages.json           # 8 canonical slugs
ls config/verticals.json         # should NOT exist

# No stale references
rg "verticals.json" -l           # should return nothing (or only docs)
rg "workflows.json" -l           # should return nothing

# KB builds clean
cd knowledge-base && npm run build   # validates all frontmatter against schema

# Type check passes
npx tsc --noEmit

# Shell still works
source scripts/work.sh && work help && work status
```

## Rules

- Follow the build-session-protocol skill for PR creation
- Commit after each stream completes (A, B, C separately or together)
- If migration count is large (60+ files), use a script rather than manual edits
- Validate with `npm run kb:build` after every schema or frontmatter change
