vertical: colors
waves:
  - name: "Wave 0: Foundation"
    serial: true
    sessions:
      - topic: colors-foundation
        stage: build
        prompt: |
          ## Color Preferences — Foundation (Wave 0)

          You are building the foundation layer for the Color Preference System.
          Everything in Wave 1+ depends on your output.

          ### Read First
          1. `CLAUDE.md` — project rules, design system, quality checklist
          2. `docs/breadboards/color-preference-breadboard.md` — full affordance map (your bible)
          3. `docs/shaping/colors/shaping.md` — requirements and shape context
          4. `docs/plans/2026-02-15-colors-impl-plan.md` — implementation plan (Wave 0 tasks)

          ### What to Build

          **1. Schemas + Types** (`lib/schemas/color-preferences.ts` — NEW)
          - `brandPreferenceSchema`: brandName, inheritMode ('inherit'|'customize'), favoriteColorIds[], explicitColorIds[], removedInheritedColorIds[]
          - `customerPreferenceSchema`: inheritMode, favoriteColorIds[], favoriteBrandNames[], favoriteGarmentIds[]
          - `inheritanceModeSchema`, `displayPreferenceSchema`, `propagationConfigSchema`
          - Export all z.infer types

          **2. Customer Schema Evolution** (`lib/schemas/customer.ts` — MODIFY)
          - Change `favoriteColors` from `z.record(z.string(), z.array(z.string()))` to `z.array(z.string())`
          - Add `favoriteBrandNames: z.array(z.string()).default([])`
          - Update existing tests in `lib/schemas/__tests__/`

          **3. Mock Data** (`lib/mock-data.ts` — MODIFY)
          - Add `brandPreferences` map: Gildan (customize, adds Sport Grey + Heather Athletic), Bella+Canvas (inherit), Comfort Colors (customize, adds Seafoam + Butter, removes Red)
          - Update customer favoriteColors from Record<garmentId, colorId[]> to string[]
          - Add `autoPropagationConfig: { autoPropagate: true }`
          - Add `displayPreference: 'flat'`

          **4. Shared Helpers** (`lib/helpers/color-preferences.ts` — NEW)
          - `resolveEffectiveFavorites(entityType, entityId)` — N19: walk global→brand→customer, return colorIds[] (empty [] fallback)
          - `getInheritanceChain(entityType, entityId)` — N20: return { globalDefaults, addedAtLevel, removedAtLevel }
          - `propagateAddition(level, colorId)` — N22: if S8=true, find inheriting children → append
          - `getImpactPreview(level, colorId)` — N21: return { supplierCount, customerCount, suppliers[], customers[] }
          - Write comprehensive tests for all 4 helpers

          **5. ColorSwatchPicker Extension** (`components/features/ColorSwatchPicker.tsx` — MODIFY)
          - Add `multiSelect` prop: boolean
          - Add `selectedColorIds` prop: string[]
          - Add `onToggleColor` callback: (colorId: string) => void
          - When multiSelect=true: click toggles colorId in/out of selectedColorIds
          - Existing single-select behavior unchanged

          **6. Shared Components** (all NEW in `components/features/`)
          - `FavoritesColorSection.tsx`: two-section layout (favorites at top, all colors below). Props: favorites, allColors, onToggle, readOnly?, showBadges?, badgeData?. Single ScrollArea wrapping both sections.
          - `InheritanceToggle.tsx`: Beth Meyer toggle. Props: parentLabel, mode, onChange. Two states: "Use [parent] colors" / "Customize colors".
          - `InheritanceDetail.tsx`: progressive disclosure chain. Props: chain, onRestore?. Uses shadcn Collapsible. Shows global defaults, added, removed with restore action.

          **7. Navigation** (MODIFY)
          - `components/layout/sidebar.tsx`: add `/settings/colors` to SIDEBAR_SETTINGS_ORDER
          - `lib/constants/navigation.ts`: add Color Settings nav item with Palette icon
          - `docs/APP_FLOW.md`: add /settings/colors to screen inventory

          ### Quality
          - Run `npm test` — all existing + new tests pass
          - Run `npx tsc --noEmit` — no type errors
          - Run `npm run lint` — clean
          - Mobile-friendly: FavoritesColorSection must work on mobile (44px touch targets, responsive grid)

          ### Skills
          - Use `build-session-protocol` for completion flow
          - Create KB session doc when done

  - name: "Wave 1: Catalog UX + Global Settings"
    serial: false
    sessions:
      - topic: colors-swatch-filter
        stage: build
        dependsOn: colors-foundation
        prompt: |
          ## V1: Swatch Filter + Honest Cards

          Build the visual swatch filter for the garment catalog and update cards to show favorites-first.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V1: Swatch Filter + Honest Cards"
          3. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 1.1
          4. Existing code:
             - `app/(dashboard)/garments/_components/GarmentCatalogToolbar.tsx` — has color family <Select> to replace
             - `app/(dashboard)/garments/_components/GarmentCard.tsx` — currently shows first 8 colors
             - `app/(dashboard)/garments/page.tsx` — filter logic
             - `components/features/ColorSwatchPicker.tsx` — now has multiSelect mode (from Wave 0)

          ### What to Build

          **1. ColorFilterGrid** (`garments/_components/ColorFilterGrid.tsx` — NEW)
          - Wraps ColorSwatchPicker in multiSelect mode, compact layout
          - Shows all catalog colors as clickable swatches
          - Selected colors reflected in URL param `?colors=id1,id2`
          - Compact enough for toolbar inline display

          **2. GarmentCatalogToolbar** (MODIFY)
          - Remove the color family `<Select>` dropdown and `colorFamily` URL param
          - Replace with `<ColorFilterGrid>` inline in toolbar
          - Active color filter pills (U2): show selected color swatches with X to remove
          - "Clear colors" link (U3): resets ?colors= param
          - Keep brand filter, search, category tabs, view toggle unchanged

          **3. GarmentCard** (MODIFY)
          - Import `resolveEffectiveFavorites` from `lib/helpers/color-preferences.ts`
          - Show only favorite colors in compact swatches (currently shows first 8)
          - If no favorites resolved: show first 8 as fallback (R5 graceful degradation)
          - Add "N colors available" count badge below swatches
          - Make brand name clickable: add `onBrandClick` prop, render as clickable text (handler wired in Wave 2)

          **4. garments/page.tsx** (MODIFY)
          - Replace `filterByColorFamily(family)` with `getFilteredGarmentsByColors(colorIds[])` (N23)
          - Read `?colors=` URL param as comma-separated color IDs
          - Filter: show garments that have ANY of the selected colors in their palette
          - Pass `onBrandClick` stub to GarmentCard (no-op until Wave 2)
          - Remove `colorFamilies` prop derivation (no longer needed)

          ### URL State
          - `?colors=clr-black,clr-white` — multi-select color filter
          - Empty or absent = show all garments (no filter)
          - Combine with existing `?category=`, `?brand=`, `?q=`, `?view=`

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Mobile: swatch grid must wrap on mobile, pills must be scrollable
          - Keyboard: swatches focusable, Enter/Space to toggle

          ### Demo
          "Click color swatches to filter; cards show favorites + count"

      - topic: colors-drawer-favorites
        stage: build
        dependsOn: colors-foundation
        prompt: |
          ## V2: Drawer Favorites + Scroll Fix

          Update the garment detail drawer to show favorites-first with a fixed scroll.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V2: Drawer Favorites + Scroll Fix"
          3. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 1.2
          4. Existing code:
             - `app/(dashboard)/garments/_components/GarmentDetailDrawer.tsx` — currently uses single ColorSwatchPicker
             - `components/features/FavoritesColorSection.tsx` — two-section layout (from Wave 0)

          ### What to Build

          **1. GarmentDetailDrawer** (MODIFY — this is the only file you touch)
          - Replace single `ColorSwatchPicker` with `FavoritesColorSection`:
            - Compute favorites via `resolveEffectiveFavorites('global')` (Phase 1 = always global)
            - Pass resolved favorites + all garment colors
          - Wire `onToggle` → N3 `toggleDrawerFavorite(colorId)`:
            - Accept `context` prop: `{ context: 'global' | 'brand' | 'customer', contextId?: string }`
            - Phase 1: context always = 'global' → toggle isFavorite on color in mock data
            - Update state immediately (optimistic)
          - Fix scroll bug:
            - Remove any inner ScrollArea from the color section
            - Ensure drawer's outer ScrollArea wraps favorites section + all colors section
            - Verify: open drawer with garment that has 60+ colors, scroll must reach bottom
          - Keep existing:
            - Selected color name + hex display (U14) — clicking a swatch in either section selects it
            - Size/price matrix (U15) — updates when color selection changes
            - Brand name: make clickable, add `onBrandClick` prop (stub → Wave 2)
            - Linked jobs table (U31-U32) — unchanged

          ### Scroll Fix Detail
          The current bug: nested ScrollArea in ColorSwatchPicker + drawer's own ScrollArea causes truncation.
          Fix: FavoritesColorSection uses no ScrollArea internally. The drawer wraps everything in one ScrollArea.

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Mobile: drawer uses Sheet on mobile (md: breakpoint), full height
          - Verify scroll with Gildan G5000 (has many colors in mock data)

          ### Demo
          "Open drawer: favorites at top, full palette below, scrolls correctly"

      - topic: colors-global-settings
        stage: build
        dependsOn: colors-foundation
        prompt: |
          ## V3: Global Favorites Page

          Build the Settings > Colors page for managing shop-wide favorite colors.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V3: Global Favorites Page"
          3. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 1.3
          4. Existing code:
             - `app/(dashboard)/settings/pricing/page.tsx` — reference for settings page layout
             - `components/features/FavoritesColorSection.tsx` — (from Wave 0)
             - `lib/helpers/color-preferences.ts` — helpers (from Wave 0)
             - Navigation already updated (from Wave 0) — `/settings/colors` in sidebar

          ### What to Build

          **1. SettingsColorsPage** (`app/(dashboard)/settings/colors/page.tsx` — NEW)
          - Page header: "Colors" with breadcrumb (Settings > Colors)
          - Use `FavoritesColorSection` for main content:
            - Favorites = colors with `isFavorite: true` from mock data
            - All colors = full `colors` array from mock data
          - N4 `toggleGlobalFavorite(colorId)`:
            - Toggle `isFavorite` on color in state
            - If REMOVING and downstream entities exist: log console stub "→ would open RemovalConfirmationDialog" (wired in V6)
            - If ADDING and S8=true: log console stub "→ would propagate addition" (wired in V6)
          - Favorites count in heading: "Favorites (N)"

          **2. Display Preference Toggle** (U40)
          - N5 `setDisplayPreference(mode)`: 'flat' | 'grouped'
          - Store in localStorage key `color-display-preference` (S5)
          - Flat mode (default): standard swatch grid
          - Grouped mode: group swatches by `color.family` with family headers (U43)
          - Toggle UI: two-button segmented control (like view toggle in garment catalog)

          **3. Search Input** (U41)
          - N6 `searchColors(query)`: debounced 300ms
          - Filter "All Colors" section by color name or family
          - Min 2 chars to trigger
          - Clear button when active

          **4. Auto-Propagation Config** (U42)
          - N10 `setAutoPropagation(enabled)`: toggles S8 mock boolean
          - Switch component with label: "Automatically add new favorites to all brands and customers"
          - Default: true (from mock data)
          - Below main content, in a "Settings" subsection

          ### Layout Reference
          Follow the same layout pattern as `/settings/pricing` — page header, breadcrumb, main content area with card sections.

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Mobile: full-width layout, search input spans full width, swatches wrap
          - Verify: toggling favorites updates count immediately
          - Verify: grouped view shows correct family headers

          ### Demo
          "Settings > Colors: tap swatches to set shop-wide favorites"

  - name: "Wave 2: Brand Hierarchy"
    serial: true
    sessions:
      - topic: colors-brand-drawer
        stage: build
        dependsOn: colors-global-settings
        prompt: |
          ## V4: Brand Detail Drawer

          Build the brand detail drawer with inheritance toggle and per-color tracking.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V4: Brand Detail Drawer"
          3. `docs/shaping/colors/spike-brand-detail-view.md` — brand drawer navigation resolution
          4. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 2.1
          5. Existing code in garments/ — GarmentCard (has onBrandClick stub), GarmentCatalogToolbar (has brand name link), GarmentDetailDrawer (has brand name link)
          6. `components/features/InheritanceToggle.tsx`, `InheritanceDetail.tsx`, `FavoritesColorSection.tsx` — shared components from Wave 0
          7. `lib/helpers/color-preferences.ts` — resolveEffectiveFavorites, getInheritanceChain
          8. `lib/mock-data.ts` — brandPreferences mock data from Wave 0

          ### What to Build

          **1. BrandDetailDrawer** (`garments/_components/BrandDetailDrawer.tsx` — NEW)
          - Sheet/drawer component (same pattern as GarmentDetailDrawer)
          - Header: brand name + "N garments" count (U21)
          - Close button (U20)
          - InheritanceToggle (U22): "Use global colors" / "Customize colors"
          - When inherit mode:
            - FavoritesColorSection readOnly=true, showing resolved global favorites
          - When customize mode:
            - FavoritesColorSection editable, showBadges=true
            - badgeData from getInheritanceChain: "inherited" vs "added here"
          - InheritanceDetail disclosure (U26-U28):
            - Chain visualization from getInheritanceChain('brand', brandName)
            - "Restore" action on removed inherited colors → N9
          - Brand garment list (U29): compact garment cards filtered by brand

          **2. Wire Toggle Functions**
          - N7 `setBrandInheritMode(brand, mode)`: update brandPreferences map mode field
          - N8 `toggleBrandFavorite(brand, colorId)`: update favoriteColorIds, track in explicitColorIds. Stub: if removing & children exist → console log "→ would open P4". If adding & S8=true → console log "→ would propagate"
          - N9 `restoreInheritedColor(brand, colorId)`: remove from removedInheritedColorIds

          **3. Wire Brand Name Clicks**
          - N25 `openBrandDrawer(brandName)`: state in garments page
          - Update garments/page.tsx: add brand drawer open state + handler
          - Wire GarmentCard onBrandClick → openBrandDrawer (replace stub)
          - Wire GarmentCatalogToolbar brand name → openBrandDrawer
          - Wire GarmentDetailDrawer brand name → openBrandDrawer

          **4. N24 `getBrandGarments(brandName)`**
          - Filter garment catalog mock data by brand
          - Return array for brand garment list

          ### Entry Points
          Per spike resolution, 3 entry points to brand drawer:
          1. Click brand name on GarmentCard (U6)
          2. Click brand name in toolbar when brand filter is active (U7)
          3. Click brand name in GarmentDetailDrawer (U16)

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Mobile: drawer full-height Sheet on mobile
          - Verify: toggle between inherit/customize updates UI immediately
          - Verify: badge shows "inherited" for global colors, "added here" for explicit
          - Verify: restore action works on removed inherited colors

          ### Demo
          "Click 'Gildan' → drawer → toggle customize → add Sport Grey"

  - name: "Wave 3: Customer + Removal"
    serial: false
    sessions:
      - topic: colors-customer-prefs
        stage: build
        dependsOn: colors-brand-drawer
        prompt: |
          ## V5: Customer Preferences

          Build the Customer Preferences tab with independent color, brand, and garment axes.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V5: Customer Preferences"
          3. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 3.1
          4. Existing code:
             - `app/(dashboard)/customers/[id]/_components/CustomerTabs.tsx` — existing tab component
             - `app/(dashboard)/customers/[id]/page.tsx` — customer detail page
             - `components/features/FavoritesColorSection.tsx`, `InheritanceToggle.tsx`, `InheritanceDetail.tsx` — shared from Wave 0
             - `lib/helpers/color-preferences.ts` — resolveEffectiveFavorites, getInheritanceChain
             - `lib/mock-data.ts` — customer mock data (favoriteColors as string[], favoriteBrandNames from Wave 0)

          ### What to Build

          **1. CustomerPreferencesTab** (`customers/[id]/_components/CustomerPreferencesTab.tsx` — NEW)

          Three independent sections:

          **Color Preferences** (U51-U55):
          - InheritanceToggle (U52): dynamic label:
            - If customer has favoriteBrandNames.length > 0 → "Use [first brand] colors"
            - Else → "Use global colors"
          - FavoritesColorSection (U53/U54): editable when customize, readOnly when inherit
          - InheritanceDetail (U55): chain disclosure
          - N12 `setCustomerInheritMode(customerId, mode)`: update customer mock data inheritMode
          - N13 `toggleCustomerColorFavorite(customerId, colorId)`: update favoriteColors[]

          **Favorite Brands** (U56-U57):
          - Heading: "Favorite Brands"
          - Brand chips: pill-shaped toggles for each brand in catalog
          - Active state: filled chip, inactive: outline
          - N14 `toggleCustomerBrandFavorite(customerId, brand)`: toggle in favoriteBrandNames[]

          **Favorite Garments** (U58-U59):
          - Heading: "Favorite Garments"
          - Garment mini-cards: image thumbnail, brand, style name, checkbox overlay
          - Grid layout: 2 cols mobile, 3 cols desktop
          - N15 `toggleCustomerGarmentFavorite(customerId, garmentId)`: toggle in favoriteGarments[]

          **Empty States** (U60):
          - Per-axis: "No favorite colors set — using global defaults"
          - Per-axis: "No favorite brands set"
          - Per-axis: "No favorite garments set"

          **2. Update CustomerTabs** (MODIFY)
          - Add "Preferences" tab trigger (U50)
          - Tab order: Overview | Quotes | Jobs | Artwork | Screens | Preferences
          - Render CustomerPreferencesTab when Preferences selected

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Mobile: full-width sections, stacked layout
          - Verify: each axis works independently (can set brands without colors)
          - Verify: toggle between inherit/customize for colors

          ### Demo
          "Customer > Preferences: set ACME Corp's colors, brands, garments"

      - topic: colors-removal-dialog
        stage: build
        dependsOn: colors-brand-drawer
        prompt: |
          ## V6: Inheritance Engine + Removal Dialog

          Build the removal confirmation dialog and wire live propagation into V3 and V4.

          ### Read First
          1. `CLAUDE.md` — project rules, design system
          2. `docs/breadboards/color-preference-breadboard.md` — Section "V6: Inheritance Engine + Removal Dialog"
          3. `docs/plans/2026-02-15-colors-impl-plan.md` — Task 3.2
          4. Existing code:
             - `app/(dashboard)/settings/colors/page.tsx` — V3 settings page (has console stub for P4)
             - `app/(dashboard)/garments/_components/BrandDetailDrawer.tsx` — V4 brand drawer (has console stub for P4)
             - `lib/helpers/color-preferences.ts` — getImpactPreview, propagateAddition (from Wave 0)

          ### What to Build

          **1. RemovalConfirmationDialog** (`components/features/RemovalConfirmationDialog.tsx` — NEW)
          - shadcn Dialog component
          - Props: `open`, `onOpenChange`, `level: 'global' | 'brand'`, `colorId: string`, `colorName: string`, `colorHex: string`, `impactData: ImpactPreview`, `onRemoveAll`, `onRemoveLevelOnly`, `onRemoveSelected`
          - Content:
            - Color swatch + name display (U65)
            - Impact message (U66): "[colorName] will be removed from [level] favorites. N suppliers and N customers currently have this color."
            - Three buttons:
              - "Remove everywhere" (U67): calls onRemoveAll
              - "Remove from [level] only" (U68): calls onRemoveLevelOnly
              - "Cancel" (U69): closes dialog
            - Collapsible "Customize selections" (U70):
              - Suppliers section: checkboxes per brand (U71)
              - Customers section: checkboxes per customer (U71)
              - "Apply to selected (N)" button (U72): calls onRemoveSelected with checked entity IDs

          **2. Wire N16 `removeFromAll(level, colorId)`**
          - If level=global: remove isFavorite from color + remove from all brand preferences + remove from all customer preferences
          - If level=brand: remove from brand + remove from all customers of that brand

          **3. Wire N17 `removeFromLevelOnly(level, colorId)`**
          - Remove from specified level only
          - Children retain their favorites (explicit customizations preserved per R3.2)

          **4. Wire N18 `removeFromSelected(level, colorId, entityIds[])`**
          - Remove from specified entities only
          - Other entities unchanged

          **5. Make Stubs Live in SettingsColorsPage** (MODIFY `settings/colors/page.tsx`)
          - Replace console.log stub in N4 removal path:
            - Call `getImpactPreview('global', colorId)`
            - If impactData has children > 0 → open RemovalConfirmationDialog
            - Wire dialog callbacks to N16/N17/N18
          - Replace console.log stub in N4 addition path:
            - Call `propagateAddition('global', colorId)` when S8=true

          **6. Make Stubs Live in BrandDetailDrawer** (MODIFY `BrandDetailDrawer.tsx`)
          - Replace console.log stub in N8 removal path:
            - Call `getImpactPreview('brand', colorId)`
            - If impactData has children > 0 → open RemovalConfirmationDialog
            - Wire dialog callbacks
          - Replace console.log stub in N8 addition path:
            - Call `propagateAddition('brand', colorId)` when S8=true

          ### UI Details
          - Dialog uses shadcn Dialog (not Sheet — it's a modal, not a drawer)
          - Selective propagation section starts collapsed (progressive disclosure per D6)
          - "Apply to selected" button shows dynamic count of checked entities
          - All checkboxes default to checked (remove all is the expected default action)

          ### Quality
          - Run `npm test && npx tsc --noEmit && npm run lint`
          - Verify: removing a global favorite with children shows dialog
          - Verify: removing a global favorite with NO children removes directly (no dialog)
          - Verify: "Remove from global only" preserves brand/customer favorites
          - Verify: "Customize selections" allows deselecting specific entities
          - Verify: propagateAddition fires when adding and S8=true

          ### Demo
          "Remove global color → '5 customers affected' → choose targets"
