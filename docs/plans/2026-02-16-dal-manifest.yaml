vertical: dal
waves:
  # ============================================================================
  # WAVE 0: Foundation Infrastructure
  # ============================================================================
  - name: 'Foundation Infrastructure'
    serial: true
    sessions:
      - topic: dal-foundation
        stage: build
        prompt: |
          # DAL Foundation Infrastructure

          ## Read First
          1. `CLAUDE.md` — project rules, design system, quality checklist
          2. `docs/shaping/dal/shaping.md` — Shape B parts B5, B9, B10, B12, B13, B14
          3. `docs/breadboards/dal-breadboard.md` — V1 affordances (N30-N37, N35, N60-N63)
          4. `docs/research/2026-02-16-dal-security-audit.md` — security requirements
          5. `lib/schemas/` — existing Zod schemas (for type references)

          ## What to Build

          Create the DAL shared infrastructure layer. All subsequent waves depend on this.

          ### 1. Directory Structure
          Create:
          ```
          lib/dal/
          lib/dal/_shared/
          lib/dal/_providers/
          lib/dal/_providers/mock/
          ```

          ### 2. Result Type (`lib/dal/_shared/result.ts`)
          ```typescript
          export type Result<T, E extends string = string> =
            | { ok: true; value: T }
            | { ok: false; error: E };

          export function ok<T>(value: T): Result<T, never> {
            return { ok: true, value };
          }

          export function err<E extends string>(error: E): Result<never, E> {
            return { ok: false, error };
          }

          export function isOk<T, E extends string>(result: Result<T, E>): result is { ok: true; value: T } {
            return result.ok === true;
          }

          export function isErr<T, E extends string>(result: Result<T, E>): result is { ok: false; error: E } {
            return result.ok === false;
          }
          ```

          ### 3. Validation (`lib/dal/_shared/validation.ts`)
          ```typescript
          import { z } from 'zod';

          const uuidSchema = z.string().uuid();

          export function validateUUID(id: string): string | null {
            const result = uuidSchema.safeParse(id);
            return result.success ? result.data : null;
          }
          ```

          ### 4. Errors (`lib/dal/_shared/errors.ts`)
          ```typescript
          export type DalErrorCode = 'NOT_FOUND' | 'VALIDATION' | 'PROVIDER' | 'UNKNOWN';

          export class DalError extends Error {
            constructor(
              public readonly code: DalErrorCode,
              message: string,
              public readonly cause?: unknown,
            ) {
              super(message);
              this.name = 'DalError';
            }
          }
          ```

          ### 5. Provider Router (`lib/dal/_providers/index.ts`)
          ```typescript
          const VALID_PROVIDERS = ['mock', 'supabase'] as const;
          export type ProviderName = (typeof VALID_PROVIDERS)[number];

          export function getProviderName(): ProviderName {
            const name = process.env.DATA_PROVIDER;
            if (!name) {
              throw new DalError('PROVIDER', "DATA_PROVIDER env var is not set. Must be 'mock' or 'supabase'.");
            }
            if (!VALID_PROVIDERS.includes(name as ProviderName)) {
              throw new DalError('PROVIDER', `DATA_PROVIDER must be 'mock' or 'supabase', got: '${name}'`);
            }
            return name as ProviderName;
          }
          ```

          ### 6. Security Headers (`next.config.ts`)
          Add to the Next.js config's `headers()`:
          - `X-Content-Type-Options: nosniff`
          - `X-Frame-Options: DENY`
          - `Referrer-Policy: strict-origin-when-cross-origin`

          ### 7. Dependencies
          - Run `npm install server-only` (install only, don't add `import 'server-only'` to any files)
          - Create `.env.local` with `DATA_PROVIDER=mock`

          ### 8. CLAUDE.md Updates
          Add under Coding Standards:
          - "Import from `@/lib/dal/{domain}`, never from `mock-data.ts` or `db/` directly"
          - "Never use `sql.raw()` with user input"
          - "DAL functions validate ID inputs with Zod"

          ### 9. Foundation Tests
          Create test files:
          - `lib/dal/__tests__/result.test.ts` — ok/err constructors, isOk/isErr guards
          - `lib/dal/__tests__/validation.test.ts` — valid UUIDs pass, invalid return null
          - `lib/dal/__tests__/provider-router.test.ts` — valid providers return name, invalid throws

          ## Quality
          - `npm test` — all 529 existing tests pass + new foundation tests
          - `npm run build` — clean build with security headers
          - `npx tsc --noEmit` — no type errors
          - Provider router throws on `DATA_PROVIDER=invalid`

          ## Demo
          Foundation tests green. Build passes with security headers. Provider router throws on bad env.

  # ============================================================================
  # WAVE 1: All Domain Providers + Customer Migration
  # ============================================================================
  - name: 'All Domain Providers + Customer Migration'
    serial: true
    sessions:
      - topic: dal-providers
        stage: build
        dependsOn: dal-foundation
        prompt: |
          # DAL Domain Providers + Customer Pattern Reference

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — full plan with migration patterns
          3. `docs/breadboards/dal-breadboard.md` — all P2 and P4 affordances
          4. `docs/shaping/dal/shaping.md` — Shape B parts B1, B2, B11
          5. `lib/mock-data.ts` — source data arrays and existing query functions
          6. `lib/schemas/` — Zod schemas for all entity types
          7. `lib/dal/_shared/` — Result type, validation, errors (created in Wave 0)

          ## What to Build

          ### Part 1: Create All 9 Mock Provider Files

          Each file in `lib/dal/_providers/mock/` wraps raw data from `lib/mock-data.ts` in async functions.

          **Critical rules:**
          - All functions are `async` (even though mock data resolves instantly)
          - Return **copies** (`[...array]` or `array.map(item => ({...item}))`) — NEVER references
          - For getById functions: validate UUID with `validateUUID()`, return `T | null`
          - For getAll functions: return `T[]` (copy of full array)
          - For filtered queries: validate UUID, filter source array, return copies
          - Import types from `@/lib/schemas/`, data from `@/lib/mock-data`

          **Files to create:**

          1. `lib/dal/_providers/mock/customers.ts`
             Functions: `getCustomers()`, `getCustomerById(id)`, `getCustomerQuotes(customerId)`,
             `getCustomerJobs(customerId)`, `getCustomerContacts(customerId)`,
             `getCustomerNotes(customerId)`, `getCustomerArtworks(customerId)`,
             `getCustomerInvoices(customerId)`
             Source arrays: customers, contacts, customerGroups, customerAddresses, customerNotes, quotes, jobs, invoices, artworks

          2. `lib/dal/_providers/mock/jobs.ts`
             Functions: `getJobs()`, `getJobById(id)`, `getJobsByLane(lane)`,
             `getJobsByServiceType(type)`, `getJobTasks(jobId)`, `getJobNotes(jobId)`,
             `getQuoteCards()`, `getScratchNotes()`
             Source arrays: jobs, quoteCards, scratchNotes

          3. `lib/dal/_providers/mock/quotes.ts`
             Functions: `getQuotes()`, `getQuoteById(id)`
             Source arrays: quotes

          4. `lib/dal/_providers/mock/invoices.ts`
             Functions: `getInvoices()`, `getInvoiceById(id)`, `getInvoicePayments(invoiceId)`,
             `getInvoiceCreditMemos(invoiceId)`, `getQuoteInvoice(quoteId)`
             Source arrays: invoices, payments, creditMemos

          5. `lib/dal/_providers/mock/garments.ts`
             Functions: `getGarmentCatalog()`, `getGarmentById(id)`, `getAvailableBrands()`
             Source arrays: garmentCatalog
             Note: Port simple lookup functions from `lib/helpers/garment-helpers.ts`

          6. `lib/dal/_providers/mock/colors.ts`
             Functions: `getColors()`, `getColorById(id)`
             Source arrays: colors

          7. `lib/dal/_providers/mock/screens.ts`
             Functions: `getScreens()`, `getScreensByJobId(jobId)`
             Source arrays: screens (note: cross-references jobs — filter by screen.jobId)

          8. `lib/dal/_providers/mock/settings.ts`
             Functions: `getMockupTemplates()`, `getBrandPreferences()`, `getDisplayPreference()`,
             `getAutoPropagationConfig()`, `getDtfSheetTiers()`
             Source arrays: mockupTemplates, brandPreferences, displayPreference, autoPropagationConfig, dtfSheetTiers

          9. `lib/dal/_providers/mock/artworks.ts`
             Functions: `getArtworks()`, `getArtworkById(id)`
             Source arrays: artworks

          ### Part 2: Create All 9 DAL Domain Files

          Each file in `lib/dal/` is a re-export from its mock provider:
          ```typescript
          // lib/dal/customers.ts
          export {
            getCustomers,
            getCustomerById,
            getCustomerQuotes,
            getCustomerJobs,
            getCustomerContacts,
            getCustomerNotes,
            getCustomerArtworks,
            getCustomerInvoices,
          } from './_providers/mock/customers';
          ```

          Create all 9: `customers.ts`, `jobs.ts`, `quotes.ts`, `invoices.ts`, `garments.ts`,
          `colors.ts`, `screens.ts`, `settings.ts`, `artworks.ts`.

          **NO barrel `index.ts`** — consumers import `@/lib/dal/customers`, never `@/lib/dal`.

          ### Part 3: Migrate Customer Route Group (Reference Implementation)

          After all providers exist, migrate the customer route group using the patterns
          from the implementation plan (docs/plans/2026-02-16-dal-impl-plan.md).

          Files to migrate:
          - `app/(dashboard)/customers/page.tsx` — Server Component, Pattern 2
          - `app/(dashboard)/customers/[id]/page.tsx` — Server Component, Pattern 2 (6 domain imports)
          - `app/(dashboard)/customers/_components/CustomersDataTable.tsx` — Client Component, Pattern 4
          - Check all other files in `app/(dashboard)/customers/` for mock-data imports

          For `customers/[id]/page.tsx` specifically:
          - Replace `customers.find(c => c.id === id)` with `await getCustomerById(id)`
          - Replace `quotes.filter(q => q.customerId === id)` with `await getCustomerQuotes(id)`
          - Replace `jobs.filter(j => j.customerId === id)` with `await getCustomerJobs(id)`
          - Replace `invoices.filter(inv => inv.customerId === id)` with `await getCustomerInvoices(id)`
          - Replace `artworks.filter(a => a.customerId === id)` with `await getCustomerArtworks(id)`
          - Replace `customerNotes.filter(...)` with `await getCustomerNotes(id)`
          - The `customers.filter(c => c.referredByCustomerId === id)` for referralCount
            needs `await getCustomers()` and then filter client-side (or add a DAL function)

          ### Part 4: Customer Domain Tests

          Create `lib/dal/__tests__/customers.test.ts`:
          - Each function returns correct type
          - getById with valid ID returns entity
          - getById with non-existent ID returns null
          - getById with invalid UUID returns null
          - Returned data is a copy (modify result, check source unchanged)
          - Relational queries (getCustomerQuotes) return correct filtered results

          ## Quality
          - `npm test` — all existing tests pass + new DAL tests
          - `npm run build` — clean
          - Customer pages render correctly
          - Verify: `grep -r "from.*mock-data" app/(dashboard)/customers/` returns zero results

          ## Demo
          Customer pages render via DAL. All tests pass. 18 new DAL files created.

  # ============================================================================
  # WAVE 2: Consumer Migration (Parallel)
  # ============================================================================
  - name: 'Consumer Migration'
    serial: false
    sessions:
      # --- Session A: Dashboard + Jobs ---
      - topic: dal-migrate-dashboard-jobs
        stage: build
        dependsOn: dal-providers
        prompt: |
          # DAL Consumer Migration: Dashboard + Jobs Route Group

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — migration patterns (ALL 4 PATTERNS)
          3. `lib/dal/` — all DAL domain files (created in Wave 1)
          4. `app/(dashboard)/customers/` — reference implementation (migrated in Wave 1)

          ## What to Build

          Migrate ALL mock-data imports in the Dashboard page and Jobs route group to use DAL.

          ### Dashboard Page (`app/(dashboard)/page.tsx`)
          **Migration Pattern 1** — Server Component with module-level arrays.

          This page has module-level computations:
          ```tsx
          const blockedJobs = jobs.filter(j => j.lane === "blocked");
          ```
          These MUST move inside the component function because DAL functions are async:
          ```tsx
          export default async function DashboardPage() {
            const [jobs, customers] = await Promise.all([getJobs(), getCustomers()]);
            const blockedJobs = jobs.filter(j => j.lane === "blocked");
            // ... rest of computations
          }
          ```
          Also move `getCustomerName()` helper inside the component (it needs the `customers` array).

          ### Jobs Board Page (`app/(dashboard)/jobs/board/page.tsx`)
          **Migration Pattern 3** — Client Component page that must be split.

          This is a `"use client"` page that imports `jobs`, `quoteCards`, `scratchNotes` from mock-data.
          It MUST be split into:
          1. New `page.tsx` (Server Component) — fetches data via DAL, passes as props
          2. Move existing content to `_components/ProductionBoard.tsx` (Client Component)

          The Server Component page:
          ```tsx
          import { getJobs, getQuoteCards, getScratchNotes } from "@/lib/dal/jobs";
          import { ProductionBoard } from "./_components/ProductionBoard";
          export default async function ProductionBoardPage() {
            const [jobs, quoteCards, scratchNotes] = await Promise.all([
              getJobs(), getQuoteCards(), getScratchNotes(),
            ]);
            return (
              <>
                <Topbar breadcrumbs={...} />
                <ProductionBoard
                  initialJobs={jobs}
                  initialQuoteCards={quoteCards}
                  initialScratchNotes={scratchNotes}
                />
              </>
            );
          }
          ```

          The Client Component (`ProductionBoard.tsx`):
          - Remove `"use client"` page wrapper, make it a named export component
          - Accept `initialJobs`, `initialQuoteCards`, `initialScratchNotes` as props
          - Remove mock-data imports
          - Keep ALL existing hooks, state, DnD logic unchanged
          - Note: `board-projections` helper imports stay as-is (migrated in Wave 3)

          ### Other Jobs Files
          Migrate all other files in `app/(dashboard)/jobs/` that import from mock-data:
          - `jobs/page.tsx` — Server Component, straightforward
          - `jobs/[id]/page.tsx` — Server Component, straightforward
          - Any `_components/` files that import mock-data directly

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Dashboard page renders all sections correctly
          - Jobs board page renders with DnD working
          - Jobs list page renders correctly
          - Verify: `grep -r "from.*mock-data" app/\(dashboard\)/page.tsx app/\(dashboard\)/jobs/` returns zero results

          ## Demo
          Dashboard and Jobs pages render correctly via DAL. Board DnD works.

      # --- Session B: Quotes ---
      - topic: dal-migrate-quotes
        stage: build
        dependsOn: dal-providers
        prompt: |
          # DAL Consumer Migration: Quotes Route Group

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — migration patterns (ALL 4 PATTERNS)
          3. `lib/dal/` — all DAL domain files
          4. `app/(dashboard)/customers/` — reference implementation

          ## What to Build

          Migrate ALL mock-data imports in the Quotes route group to use DAL.

          ### Quote Pages (Server Components)
          - `quotes/page.tsx` — replace mock-data imports with DAL calls
          - `quotes/new/page.tsx` — replace `quotes.find()` with `await getQuoteById()`
          - `quotes/[id]/page.tsx` — replace mock-data with DAL
          - `quotes/[id]/edit/page.tsx` — replace mock-data with DAL

          ### QuoteForm.tsx (Client Component — Pattern 4)
          This is a `"use client"` component importing from 4 domains:
          `customers`, `colors`, `garmentCatalog`, `artworks`

          The parent pages (`quotes/new/page.tsx`, `quotes/[id]/edit/page.tsx`) must fetch
          this data via DAL and pass as props to QuoteForm:
          ```tsx
          // quotes/new/page.tsx (Server Component)
          const [customers, colors, garmentCatalog, artworks, quotes] = await Promise.all([
            getCustomers(), getColors(), getGarmentCatalog(), getArtworks(), getQuotes(),
          ]);
          return <QuoteForm
            mode="create"
            customers={customers}
            colors={colors}
            garmentCatalog={garmentCatalog}
            artworks={artworks}
            initialData={initialData}
          />;
          ```

          QuoteForm.tsx changes:
          - Remove mock-data imports
          - Add props: `customers`, `colors`, `garmentCatalog`, `artworks`
          - Use props instead of imported arrays throughout the component
          - Keep all form logic, calculations, and UI unchanged

          Also check: `QuotesDataTable.tsx` and any other quote components for mock-data imports.

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - New Quote form works with customer select, garment select, color select
          - Quote edit form populates correctly
          - Verify: `grep -r "from.*mock-data" app/\(dashboard\)/quotes/` returns zero results

          ## Demo
          Quote pages and form render correctly. New Quote form dropdowns populated.

      # --- Session C: Invoices ---
      - topic: dal-migrate-invoices
        stage: build
        dependsOn: dal-providers
        prompt: |
          # DAL Consumer Migration: Invoices Route Group

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — migration patterns
          3. `lib/dal/` — all DAL domain files
          4. `app/(dashboard)/customers/` — reference implementation

          ## What to Build

          Migrate ALL mock-data imports in the Invoices route group to use DAL.

          ### Invoice Pages (Server Components)
          - `invoices/page.tsx` — replace mock-data with DAL
          - `invoices/[id]/page.tsx` — replace mock-data with DAL
          - `invoices/[id]/edit/page.tsx` — already async, replace `invoices.find()` with `await getInvoiceById()`

          ### Client Components (Pattern 4)
          - `InvoiceStatsBar.tsx` — if it imports mock-data, parent passes data as props
          - `InvoicesDataTable.tsx` — if it imports mock-data, parent passes data as props
          - Check all `_components/` files for mock-data imports

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Invoice pages render correctly
          - Invoice edit form populates correctly
          - Verify: `grep -r "from.*mock-data" app/\(dashboard\)/invoices/` returns zero results

          ## Demo
          Invoice pages render correctly via DAL.

      # --- Session D: Garments + Screens + Settings + Shared ---
      - topic: dal-migrate-remaining
        stage: build
        dependsOn: dal-providers
        prompt: |
          # DAL Consumer Migration: Garments + Screens + Settings + Shared Components

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — migration patterns
          3. `lib/dal/` — all DAL domain files
          4. `app/(dashboard)/customers/` — reference implementation

          ## What to Build

          Migrate ALL remaining mock-data imports to use DAL. This session handles
          the smaller route groups and shared components.

          ### Garments Route Group
          - `garments/page.tsx` — Server Component, imports garmentCatalog + jobs + customers
          - `GarmentCatalogDataTable.tsx` — Client Component
          - `BrandDetailDrawer.tsx` — Client Component, imports colors + garmentCatalog + brandPreferences
          - Note: `garment-helpers.ts` lookup functions are now in `dal/garments.ts` — update imports

          ### Screens Route Group
          - `screens/page.tsx` — Server Component

          ### Settings Route Group
          - `settings/colors/page.tsx` — Server Component, imports colors + autoPropagationConfig
          - `DtfTabContent.tsx` — Client Component, imports dtfSheetTiers

          ### Shared Feature Components
          - `components/features/ColorSwatchPicker.tsx` — if imports mock-data
          - `components/features/InheritanceDetail.tsx` — if imports mock-data
          - Check all files in `components/features/` for mock-data imports

          ### Helper File Updates
          - `lib/helpers/garment-helpers.ts` — imports from mock-data can now import from DAL
            (OR consumers switch to importing directly from `@/lib/dal/garments`)
          - Note: color-preferences.ts, board-projections.ts, screen-helpers.ts are handled in Wave 3

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Garment catalog page renders
          - Settings colors page renders
          - Verify: `grep -r "from.*mock-data" app/\(dashboard\)/garments/ app/\(dashboard\)/screens/ app/\(dashboard\)/settings/ components/features/` returns zero results

          ## Demo
          All remaining pages render correctly via DAL.

  # ============================================================================
  # WAVE 3: Services Extraction (Parallel)
  # ============================================================================
  - name: 'Services Extraction'
    serial: false
    sessions:
      # --- Session A: Color Resolution ---
      - topic: dal-service-colors
        stage: build
        dependsOn: dal-migrate-remaining
        prompt: |
          # DAL Services: Color Resolution

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/breadboards/dal-breadboard.md` — P6 affordances N40-N45
          3. `lib/helpers/color-preferences.ts` — existing implementation to port
          4. `lib/dal/colors.ts` — color DAL functions
          5. `lib/dal/customers.ts` — customer DAL functions
          6. `lib/dal/settings.ts` — settings DAL functions (brandPreferences, autoPropagationConfig)

          ## What to Build

          Create `lib/services/color-resolution.ts` — port the 3-level color hierarchy
          logic from `lib/helpers/color-preferences.ts` to use DAL internally.

          ### Functions to Port
          - `resolveEffectiveFavorites(entityType, entityId?)` — calls getColors(), getBrandPreferences(), getCustomerById()
          - `getInheritanceChain(entityType, entityId?)` — calls getColors(), getBrandPreferences(), getCustomerById()
          - `propagateAddition(level, colorId)` — calls getAutoPropagationConfig(), getBrandPreferences(), getCustomers()
          - `getImpactPreview(level, colorId)` — calls getBrandPreferences(), getCustomers()
          - `getBrandPreference(brandName)` — calls getBrandPreferences()
          - `removeFromAll(colorId)` — calls getBrandPreferences(), getCustomers()
          - `removeFromLevelOnly(level, entityId, colorId)` — calls getBrandPreferences(), getCustomers()
          - `removeFromSelected(selections)` — calls getBrandPreferences(), getCustomers()

          All functions become `async` since they call async DAL functions.

          ### Consumer Updates
          Find all files importing from `lib/helpers/color-preferences.ts` and update to
          import from `@/lib/services/color-resolution.ts`. Add `await` to all calls.

          Note: consumers may need to become async if they aren't already. For Server
          Components, just add `async`. For Client Components, the parent Server Component
          should call the service and pass results as props.

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Settings > Colors page works (color hierarchy visualization)
          - Color selection in QuoteForm works

          ## Demo
          Color preferences page renders with hierarchy via service layer.

      # --- Session B: Board Projections ---
      - topic: dal-service-board
        stage: build
        dependsOn: dal-migrate-dashboard-jobs
        prompt: |
          # DAL Services: Board Projections

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/breadboards/dal-breadboard.md` — P6 affordances N50-N51
          3. `lib/helpers/board-projections.ts` — existing implementation to port
          4. `lib/dal/customers.ts`, `lib/dal/invoices.ts`, `lib/dal/garments.ts`, `lib/dal/colors.ts`, `lib/dal/artworks.ts` — DAL functions used

          ## What to Build

          Create `lib/services/board-projections.ts` — port the multi-entity join logic
          from `lib/helpers/board-projections.ts` to use DAL internally.

          ### Functions to Port
          - `projectJobToCard(job)` — async, calls getCustomerById(), getInvoiceById(), getGarmentById(), getColorById(), getArtworkById()
          - `projectScratchNoteToCard(note)` — pure computation, no DAL calls needed (can stay sync)

          Note: `projectJobToCard` does individual getById lookups for each entity referenced
          by the job. In mock mode this is fast. In Phase 2, these may be batched.

          ### Consumer Updates
          Find all files importing from `lib/helpers/board-projections.ts` and update to
          import from `@/lib/services/board-projections.ts`.

          The main consumer is `ProductionBoard.tsx` (created in Wave 2 when jobs/board/page.tsx was split).
          Since `projectJobToCard` becomes async, the board initialization needs adjustment:
          ```tsx
          // Before: const [jobCards] = useState(() => initialJobs.map(projectJobToCard));
          // After: The parent page.tsx calls projectJobToCard for each job and passes projected cards
          ```
          Consider having the Server Component page do the projection and pass `JobCard[]` directly.

          Also keep `lib/helpers/job-utils.ts` (`computeTaskProgress`, `computeCapacitySummary`,
          `computeFilteredCards`) in place — these are pure computation helpers, NOT data access.

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Kanban board renders with all card data populated
          - Card customer names, garment info, color swatches all display correctly

          ## Demo
          Kanban board renders via service layer. All card fields populated correctly.

      # --- Session C: Screen Helpers ---
      - topic: dal-service-screens
        stage: build
        dependsOn: dal-migrate-remaining
        prompt: |
          # DAL Services: Screen Helpers

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/breadboards/dal-breadboard.md` — P6 affordances N52-N54
          3. `lib/helpers/screen-helpers.ts` — existing implementation to port
          4. `lib/dal/screens.ts` — screen DAL functions
          5. `lib/dal/jobs.ts` — job DAL functions

          ## What to Build

          Create `lib/services/screen-helpers.ts` — port screen derivation logic from
          `lib/helpers/screen-helpers.ts` to use DAL internally.

          ### Functions to Port
          - `getScreensByJobId(jobId)` — async, calls dal/screens.getScreensByJobId()
          - `getActiveCustomerScreens(customerId)` — async, delegates to deriveScreensFromJobs()
          - `deriveScreensFromJobs(customerId)` — async, calls getJobs()

          ### Consumer Updates
          Find all files importing from `lib/helpers/screen-helpers.ts` (~4 files) and
          update to import from `@/lib/services/screen-helpers.ts`. Add `await` to calls.

          ## Quality
          - `npm run build` — clean
          - `npm test` — all tests pass
          - Screen Room page renders
          - QuoteForm screen derivation works

          ## Demo
          Screen Room page and screen-related functionality works via service layer.

  # ============================================================================
  # WAVE 4: Cleanup + Verification
  # ============================================================================
  - name: 'Cleanup + Verification'
    serial: true
    sessions:
      - topic: dal-cleanup
        stage: build
        dependsOn: dal-service-colors
        prompt: |
          # DAL Cleanup + Verification

          ## Read First
          1. `CLAUDE.md` — project rules
          2. `docs/plans/2026-02-16-dal-impl-plan.md` — V5 tasks
          3. `docs/breadboards/dal-breadboard.md` — V5 cleanup tasks
          4. `lib/mock-data.ts` — current state (should only be imported by _providers/mock/)

          ## What to Build

          ### 1. Import Boundary Verification
          Run: `grep -r "from.*mock-data" --include="*.ts" --include="*.tsx" | grep -v "_providers/mock" | grep -v "__tests__" | grep -v "node_modules" | grep -v ".session-context"`

          This should return ZERO results. If any remain:
          - Migrate them to use DAL imports
          - If they're helper files that became services, verify the old helper is no longer imported

          ### 2. Deprecation Comments
          Add `@deprecated` JSDoc to entity array exports in `lib/mock-data.ts`:
          ```typescript
          /** @deprecated Import from @/lib/dal/customers instead */
          export const customers: Customer[] = [ ... ];
          ```

          ### 3. Remove Unused Query Functions
          `mock-data.ts` has 13 query functions (getCustomerQuotes, getJobsByLane, etc.).
          These are now handled by DAL providers. Check if any are still imported anywhere.
          If not, remove them from mock-data.ts. If still imported (by tests), leave them.

          ### 4. Clean Up Old Helper Files
          Check if the original helper files are still imported:
          - `lib/helpers/color-preferences.ts` — should be replaced by `lib/services/color-resolution.ts`
          - `lib/helpers/board-projections.ts` — should be replaced by `lib/services/board-projections.ts`
          - `lib/helpers/screen-helpers.ts` — should be replaced by `lib/services/screen-helpers.ts`
          - `lib/helpers/garment-helpers.ts` — functions moved to `dal/garments.ts`

          If no longer imported anywhere, add `@deprecated` comments.
          Do NOT delete the files — they may be imported by tests.

          ### 5. Template Updates
          Check `.claude/skills/screen-builder/templates/` for mock-data import patterns.
          Update to use DAL imports.

          ### 6. Final Verification
          Run ALL of these:
          - `npm run build` — clean build
          - `npm test` — all tests pass (529 existing + new DAL tests)
          - `npm run lint` — clean
          - `npx tsc --noEmit` — no type errors
          - Import boundary grep — zero results
          - Start dev server (`npm run dev`), manually verify:
            - Dashboard page
            - Jobs board (DnD works)
            - Customer detail page
            - New Quote form
            - Invoice edit
            - Garment catalog
            - Settings > Colors
            - Screen Room

          ## Quality
          - Every verification step above passes
          - Zero mock-data imports outside allowed locations
          - All 7 verticals render correctly

          ## Demo
          Full green build + test suite. Zero direct mock-data imports in app code.
          All pages render identically to pre-migration state.
