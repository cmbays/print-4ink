vertical: infrastructure
waves:
  - name: "Wave 0: Config Schema Gateway"
    serial: true
    sessions:
      - topic: config-schema-gateway
        stage: build
        prompt: |
          ## Config Schema Gateway — Full Build (Wave 0)

          You are building the Config Schema Gateway: a validated config module
          that all consumers import from instead of raw JSON.

          ### Read First
          1. `CLAUDE.md` — project rules, tech stack, quality checklist
          2. `knowledge-base/src/content/strategy/2026-02-16-config-schema-gateway.md` — full architectural rationale
          3. `docs/plans/2026-02-16-config-schema-gateway-impl-plan.md` — step-by-step tasks

          ### What to Build

          **1. Zod Schemas** (`lib/config/schemas.ts` — NEW)
          - `configEntryBase`: shared base with slug (kebab-case regex) + label
          - Compose schemas for all 7 config files: domains, products, tools, stages, tags, pipeline-types, pipeline-gates
          - All array schemas use `.nonempty()`
          - Export schemas + inferred types

          **2. Gateway Loader** (`lib/config/index.ts` — NEW)
          - Import raw JSON, parse through schemas (fail-fast at import time)
          - Export typed arrays: domains, products, tools, stages, tags, pipelineTypes, pipelineGates
          - Export slug tuples (typed as [string, ...string[]]): domainSlugs, productSlugs, toolSlugs, stageSlugs, tagSlugs, pipelineTypeSlugs
          - Export label lookup functions: domainLabel(), productLabel(), toolLabel(), stageLabel(), tagLabel(), pipelineTypeLabel()
          - Each label function: returns label for slug, kebab-to-title fallback for unknown slugs

          **3. Tests** (`lib/config/__tests__/config.test.ts` — NEW)
          - Schema validation: each JSON file parses against its schema
          - Structural invariants: no duplicate slugs, kebab-case format, non-empty arrays
          - Cross-file consistency: pipeline-types stages exist in stages.json, pipeline-gates stages exist in stages.json, gate `next` values resolve
          - Label lookup: known slug returns label, unknown returns fallback
          - Slug tuples: non-empty, match typed array slugs

          **4. Wire Domains into KB** (MODIFY existing files)
          - `knowledge-base/src/content.config.ts`: import domains.json, add `domain: z.enum(domains).optional()` to pipelines schema
          - `knowledge-base/src/lib/utils.ts`: add domainLabelMap + domainLabel() function following existing pattern
          - KB imports raw JSON directly (NOT from lib/config/ — Astro build boundary)

          ### Verify
          - `npm test` — all tests pass
          - `npx tsc --noEmit` — type check
          - `cd knowledge-base && npm run build` — KB builds

          ### Produce
          - All code committed and pushed to session/0216-ddd-domains-labels branch
          - KB session doc: `knowledge-base/src/content/sessions/2026-02-16-config-schema-gateway.md`
